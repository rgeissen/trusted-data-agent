      """

        Generates sequences of token ids for models with a language modeling head.

        <Tip warning={true}>

        Most generation-controlling parameters are set in `generation_config` which, if not passed, will be set to the
        model's default generation configuration. You can override any `generation_config` by passing the corresponding
        parameters to generate(), e.g. `.generate(inputs, num_beams=4, do_sample=True)`.

        For an overview of generation strategies and code examples, check out the [following
        guide](./generation_strategies).

        </Tip>

        Parameters:
            inputs (`torch.Tensor` of varying shape depending on the modality, *optional*):
                The sequence used as a prompt for the generation or as model inputs to the encoder. If `None` the
                method initializes it with `bos_token_id` and a batch size of 1. For decoder-only models `inputs`
                should be in the format `input_ids`. For encoder-decoder models *inputs* can represent any of
                `input_ids`, `input_values`, `input_features`, or `pixel_values`.
            generation_config (`~generation.GenerationConfig`, *optional*):
                The generation configuration to be used as base parametrization for the generation call. `**kwargs`
                passed to generate matching the attributes of `generation_config` will override them. If
                `generation_config` is not provided, the default will be used, which had the following loading
                priority: 1) from the `generation_config.json` model file, if it exists; 2) from the model
                configuration. Please note that unspecified parameters will inherit [`~generation.GenerationConfig`]'s
                default values, whose documentation should be checked to parameterize generation.
            logits_processor (`LogitsProcessorList`, *optional*):
                Custom logits processors that complement the default logits processors built from arguments and
                generation config. If a logit processor is passed that is already created with the arguments or a
                generation config an error is thrown. This feature is intended for advanced users.
            stopping_criteria (`StoppingCriteriaList`, *optional*):
                Custom stopping criteria that complement the default stopping criteria built from arguments and a
                generation config. If a stopping criteria is passed that is already created with the arguments or a
                generation config an error is thrown. This feature is intended for advanced users.
            synced_gpus (`bool`, *optional*, defaults to `False`):
                Whether to continue running the while loop until max_length (needed to avoid deadlocking with
                `FullyShardedDataParallel` and DeepSpeed ZeRO Stage 3).
            streamer (`BaseStreamer`, *optional*):
                Streamer object that will be used to stream the generated sequences. Generated tokens are passed
                through `streamer.put(token_ids)` and the streamer is responsible for any further processing.
            kwargs (`dict[str, Any]`, *optional*):
                Ad hoc parametrization of `generate_config` and/or additional model-specific kwargs that will be
                forwarded to the `forward` function of the model. If the model is an encoder-decoder model, encoder
                specific kwargs should not be prefixed and decoder specific kwargs should be prefixed with *decoder_*.

        Return:
            [`~utils.ModelOutput`] or `torch.LongTensor`: A [`~utils.ModelOutput`] (if `return_dict_in_generate=True`
            or when `config.return_dict_in_generate=True`) or a `torch.FloatTensor`.

                If the model is *not* an encoder-decoder model (`model.config.is_encoder_decoder=False`), the possible
                [`~utils.ModelOutput`] types are:

                    - [`~generation.GenerateDecoderOnlyOutput`],
                    - [`~generation.GenerateBeamDecoderOnlyOutput`]

                If the model is an encoder-decoder model (`model.config.is_encoder_decoder=True`), the possible
                [`~utils.ModelOutput`] types are:

                    - [`~generation.GenerateEncoderDecoderOutput`],
                    - [`~generation.GenerateBeamEncoderDecoderOutput`]
        """
        # 1. Handle `generation_config` and kwargs that might update it, and validate the resulting objects
        if generation_config is None:
            generation_config = self.generation_config

        generation_config = copy.deepcopy(generation_config)
        model_kwargs = generation_config.update(**kwargs)  # All unused kwargs must be model kwargs
        generation_config.validate()
        self._validate_model_kwargs(model_kwargs.copy())

        # 2. Set generation parameters if not already defined
        logits_processor = logits_processor if logits_processor is not None else LogitsProcessorList()
        stopping_criteria = stopping_criteria if stopping_criteria is not None else StoppingCriteriaList()

        requires_attention_mask = "encoder_outputs" not in model_kwargs
        kwargs_has_attention_mask = model_kwargs.get("attention_mask", None) is not None

        # 3. Define model inputs
        inputs_tensor, model_input_name, model_kwargs = self._prepare_model_inputs(
            inputs, generation_config.bos_token_id, model_kwargs
        )
        batch_size = inputs_tensor.shape[0]
        self._prepare_special_tokens(generation_config, kwargs_has_attention_mask, device=inputs_tensor.device)

        # 4. Define other model kwargs
        model_kwargs["use_cache"] = generation_config.use_cache
        model_kwargs["guidance_scale"] = generation_config.guidance_scale

        if model_kwargs.get("attention_mask", None) is None and requires_attention_mask:
            model_kwargs["attention_mask"] = self._prepare_attention_mask_for_generation(
                inputs_tensor, generation_config, model_kwargs
            )

        if "encoder_hidden_states" not in model_kwargs:
            # encoder_hidden_states are created and added to `model_kwargs`
            model_kwargs = self._prepare_encoder_hidden_states_kwargs_for_generation(
                inputs_tensor, model_kwargs, model_input_name, generation_config
            )

        # 5. Prepare `input_ids` which will be used for auto-regressive generation
        input_ids, model_kwargs = self._prepare_decoder_input_ids_for_generation(
            batch_size=batch_size,
            model_input_name=model_input_name,
            model_kwargs=model_kwargs,
            decoder_start_token_id=generation_config._decoder_start_token_tensor,
            bos_token_id=generation_config._bos_token_tensor,
            device=inputs_tensor.device,
        )

        # 6. Prepare `max_length` depending on other stopping criteria.
        input_ids_length = input_ids.shape[-1]
        has_default_max_length = kwargs.get("max_length") is None and generation_config.max_length is not None
        has_default_min_length = kwargs.get("min_length") is None and generation_config.min_length is not None
        generation_config = self._prepare_generated_length(
            generation_config=generation_config,
            has_default_max_length=has_default_max_length,
            has_default_min_length=has_default_min_length,
            model_input_name=model_input_name,
            inputs_tensor=inputs_tensor,
            input_ids_length=input_ids_length,
        )

        self._validate_generated_length(generation_config, input_ids_length, has_default_max_length)

        # 7. Prepare the cache.
        # - `model_kwargs` may be updated in place with a cache as defined by the parameters in `generation_config`.
        # - different models have a different cache name expected by the model (default = "past_key_values")
        # - `max_length`, prepared above, is used to determine the maximum cache length
        max_cache_length = generation_config.max_length - 1
        if (
            inputs_tensor.shape[1] != input_ids_length
            and model_input_name == "inputs_embeds"
            and not self.config.is_encoder_decoder
        ):
            max_cache_length += inputs_tensor.shape[1]
        self._prepare_cache_for_generation(
            generation_config,
            model_kwargs,
            assistant_model=None,
            batch_size=batch_size,
            max_cache_length=max_cache_length,
            device=inputs_tensor.device,
        )

        # build the delay pattern mask for offsetting each codebook prediction by 1 (this behaviour is specific to MusicGen)
        input_ids, decoder_delay_pattern_mask = self.decoder.build_delay_pattern_mask(
            input_ids,
            pad_token_id=generation_config._decoder_start_token_tensor,
            max_length=generation_config.max_length,
        )
        # stash the delay mask so that we don't have to recompute in each forward pass
        model_kwargs["decoder_delay_pattern_mask"] = decoder_delay_pattern_mask

        # input_ids are ready to be placed on the streamer (if used)
        if streamer is not None:
            streamer.put(input_ids.cpu())

        # 8. determine generation mode
        generation_mode = generation_config.get_generation_mode()

        # 9. prepare batched CFG externally (to enable coexistence with the unbatched CFG)
        if generation_config.guidance_scale is not None and generation_config.guidance_scale > 1:
            logits_processor.append(ClassifierFreeGuidanceLogitsProcessor(generation_config.guidance_scale))
            generation_config.guidance_scale = None

        # 10. prepare distribution pre_processing samplers
        logits_processor = self._get_logits_processor(
            generation_config=generation_config,
            input_ids_seq_length=input_ids_length,
            encoder_input_ids=inputs_tensor,
            prefix_allowed_tokens_fn=None,
            logits_processor=logits_processor,
            device=input_ids.device,
        )

        # 10. prepare stopping criteria
        stopping_criteria = self._get_stopping_criteria(
            generation_config=generation_config, stopping_criteria=stopping_criteria
        )

        if generation_mode in (GenerationMode.SAMPLE, GenerationMode.GREEDY_SEARCH):
            # expand input_ids with `num_return_sequences` additional sequences per batch
            input_ids, model_kwargs = self._expand_inputs_for_generation(
                input_ids=input_ids,
                expand_size=generation_config.num_return_sequences,
                is_encoder_decoder=self.config.is_encoder_decoder,
                **model_kwargs,
            )

            # 11. run sample
            outputs = self._sample(
                input_ids,
                logits_processor=logits_processor,
                stopping_criteria=stopping_criteria,
                generation_config=generation_config,
                synced_gpus=synced_gpus,
                streamer=streamer,
                **model_kwargs,
            )

        else:
            raise ValueError(
                "Got incompatible mode for generation, should be one of greedy or sampling. "
                "Ensure that beam search is de-activated by setting `num_beams=1` and `num_beam_groups=1`."
            )

        if generation_config.return_dict_in_generate:
            output_ids = outputs.sequences
        else:
            output_ids = outputs

        # apply the pattern mask to the final ids
        output_ids = self.decoder.apply_delay_pattern_mask(output_ids, model_kwargs["decoder_delay_pattern_mask"])

        # revert the pattern delay mask by filtering the pad token id
        output_ids = output_ids[output_ids != generation_config._pad_token_tensor].reshape(
            batch_size, self.decoder.num_codebooks, -1
        )

        # append the frame dimension back to the audio codes
        output_ids = output_ids[None, ...]

        audio_scales = model_kwargs.get("audio_scales")
        if audio_scales is None:
            audio_scales = [None] * batch_size

        if self.decoder.config.audio_channels == 1:
            output_values = self.audio_encoder.decode(
                output_ids,
                audio_scales=audio_scales,
            ).audio_values
        else:
            codec_outputs_left = self.audio_encoder.decode(output_ids[:, :, ::2, :], audio_scales=audio_scales)
            output_values_left = codec_outputs_left.audio_values

            codec_outputs_right = self.audio_encoder.decode(output_ids[:, :, 1::2, :], audio_scales=audio_scales)
            output_values_right = codec_outputs_right.audio_values

            output_values = torch.cat([output_values_left, output_values_right], dim=1)

        if generation_config.return_dict_in_generate:
            outputs.sequences = output_values
            return outputs
        else:
            return output_values


__all__ = [
    "MusicgenMelodyForConditionalGeneration",
    "MusicgenMelodyForCausalLM",
    "MusicgenMelodyModel",
    "MusicgenMelodyPreTrainedModel",
]
    t       m   a   s   k   s       a   l   l       p   a   d   d   i   n   g       t   o   k   e   n   s       a   s       0       w   i   t   h       t   h   e       s   a   m   e       s   h   a   p   e       o   f       e   x   p   e   r   t   _   m   a   s   k   
                                   e   x   p   e   r   t   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       (   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   [   N   o   n   e   ,       :   ,       :   ,       N   o   n   e   ,       N   o   n   e   ]   
                                                   .   e   x   p   a   n   d   (   (   n   u   m   _   h   i   d   d   e   n   _   l   a   y   e   r   s   ,       b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       t   o   p   _   k   ,       n   u   m   _   e   x   p   e   r   t   s   )   )   
                                                   .   r   e   s   h   a   p   e   (   -   1   ,       t   o   p   _   k   ,       n   u   m   _   e   x   p   e   r   t   s   )   
                                                   .   t   o   (   c   o   m   p   u   t   e   _   d   e   v   i   c   e   )   
                                   )   
   
                                   #       C   o   m   p   u   t   e       t   h   e       p   e   r   c   e   n   t   a   g   e       o   f       t   o   k   e   n   s       r   o   u   t   e   d       t   o       e   a   c   h       e   x   p   e   r   t   s   
                                   t   o   k   e   n   s   _   p   e   r   _   e   x   p   e   r   t       =       t   o   r   c   h   .   s   u   m   (   e   x   p   e   r   t   _   m   a   s   k   .   f   l   o   a   t   (   )       *       e   x   p   e   r   t   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,       d   i   m   =   0   )       /       t   o   r   c   h   .   s   u   m   (   
                                                   e   x   p   e   r   t   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,       d   i   m   =   0   
                                   )   
   
                                   #       C   o   m   p   u   t   e       t   h   e       m   a   s   k       t   h   a   t       m   a   s   k   s       a   l   l       p   a   d   d   i   n   g       t   o   k   e   n   s       a   s       0       w   i   t   h       t   h   e       s   a   m   e       s   h   a   p   e       o   f       t   o   k   e   n   s   _   p   e   r   _   e   x   p   e   r   t   
                                   r   o   u   t   e   r   _   p   e   r   _   e   x   p   e   r   t   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       (   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   [   N   o   n   e   ,       :   ,       :   ,       N   o   n   e   ]   
                                                   .   e   x   p   a   n   d   (   (   n   u   m   _   h   i   d   d   e   n   _   l   a   y   e   r   s   ,       b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       n   u   m   _   e   x   p   e   r   t   s   )   )   
                                                   .   r   e   s   h   a   p   e   (   -   1   ,       n   u   m   _   e   x   p   e   r   t   s   )   
                                                   .   t   o   (   c   o   m   p   u   t   e   _   d   e   v   i   c   e   )   
                                   )   
   
                                   #       C   o   m   p   u   t   e       t   h   e       a   v   e   r   a   g   e       p   r   o   b   a   b   i   l   i   t   y       o   f       r   o   u   t   i   n   g       t   o       t   h   e   s   e       e   x   p   e   r   t   s   
                                   r   o   u   t   e   r   _   p   r   o   b   _   p   e   r   _   e   x   p   e   r   t       =       t   o   r   c   h   .   s   u   m   (   r   o   u   t   i   n   g   _   w   e   i   g   h   t   s       *       r   o   u   t   e   r   _   p   e   r   _   e   x   p   e   r   t   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,       d   i   m   =   0   )       /       t   o   r   c   h   .   s   u   m   (   
                                                   r   o   u   t   e   r   _   p   e   r   _   e   x   p   e   r   t   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,       d   i   m   =   0   
                                   )   
   
                   o   v   e   r   a   l   l   _   l   o   s   s       =       t   o   r   c   h   .   s   u   m   (   t   o   k   e   n   s   _   p   e   r   _   e   x   p   e   r   t       *       r   o   u   t   e   r   _   p   r   o   b   _   p   e   r   _   e   x   p   e   r   t   .   u   n   s   q   u   e   e   z   e   (   0   )   )   
                   r   e   t   u   r   n       o   v   e   r   a   l   l   _   l   o   s   s       *       n   u   m   _   e   x   p   e   r   t   s   
   
   
   @   a   u   t   o   _   d   o   c   s   t   r   i   n   g   
   c   l   a   s   s       E   r   n   i   e   4   _   5   _   M   o   e   F   o   r   C   a   u   s   a   l   L   M   (   E   r   n   i   e   4   _   5   _   M   o   e   P   r   e   T   r   a   i   n   e   d   M   o   d   e   l   ,       G   e   n   e   r   a   t   i   o   n   M   i   x   i   n   )   :   
                   _   t   i   e   d   _   w   e   i   g   h   t   s   _   k   e   y   s       =       [   "   l   m   _   h   e   a   d   .   w   e   i   g   h   t   "   ]   
                   _   t   p   _   p   l   a   n       =       {   "   l   m   _   h   e   a   d   "   :       "   c   o   l   w   i   s   e   _   r   e   p   "   }   
                   _   p   p   _   p   l   a   n       =       {   "   l   m   _   h   e   a   d   "   :       (   [   "   h   i   d   d   e   n   _   s   t   a   t   e   s   "   ]   ,       [   "   l   o   g   i   t   s   "   ]   )   }   
   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   m   o   d   e   l       =       E   r   n   i   e   4   _   5   _   M   o   e   M   o   d   e   l   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   v   o   c   a   b   _   s   i   z   e       =       c   o   n   f   i   g   .   v   o   c   a   b   _   s   i   z   e   
                                   s   e   l   f   .   l   m   _   h   e   a   d       =       n   n   .   L   i   n   e   a   r   (   c   o   n   f   i   g   .   h   i   d   d   e   n   _   s   i   z   e   ,       c   o   n   f   i   g   .   v   o   c   a   b   _   s   i   z   e   ,       b   i   a   s   =   c   o   n   f   i   g   .   u   s   e   _   b   i   a   s   )   
   
                                   s   e   l   f   .   r   o   u   t   e   r   _   a   u   x   _   l   o   s   s   _   c   o   e   f       =       c   o   n   f   i   g   .   r   o   u   t   e   r   _   a   u   x   _   l   o   s   s   _   c   o   e   f   
                                   s   e   l   f   .   n   u   m   _   e   x   p   e   r   t   s       =       c   o   n   f   i   g   .   m   o   e   _   n   u   m   _   e   x   p   e   r   t   s   
                                   s   e   l   f   .   n   u   m   _   e   x   p   e   r   t   s   _   p   e   r   _   t   o   k       =       c   o   n   f   i   g   .   m   o   e   _   k   
   
                                   #       I   n   i   t   i   a   l   i   z   e       w   e   i   g   h   t   s       a   n   d       a   p   p   l   y       f   i   n   a   l       p   r   o   c   e   s   s   i   n   g   
                                   s   e   l   f   .   p   o   s   t   _   i   n   i   t   (   )   
   
                   d   e   f       s   e   t   _   d   e   c   o   d   e   r   (   s   e   l   f   ,       d   e   c   o   d   e   r   )   :   
                                   s   e   l   f   .   m   o   d   e   l       =       d   e   c   o   d   e   r   
   
                   d   e   f       g   e   t   _   d   e   c   o   d   e   r   (   s   e   l   f   )   :   
                                   r   e   t   u   r   n       s   e   l   f   .   m   o   d   e   l   
   
                   @   c   a   n   _   r   e   t   u   r   n   _   t   u   p   l   e   
                   @   a   u   t   o   _   d   o   c   s   t   r   i   n   g   
                   d   e   f       f   o   r   w   a   r   d   (   
                                   s   e   l   f   ,   
                                   i   n   p   u   t   _   i   d   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   p   o   s   i   t   i   o   n   _   i   d   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   p   a   s   t   _   k   e   y   _   v   a   l   u   e   s   :       O   p   t   i   o   n   a   l   [   C   a   c   h   e   ]       =       N   o   n   e   ,   
                                   i   n   p   u   t   s   _   e   m   b   e   d   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   l   a   b   e   l   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   u   s   e   _   c   a   c   h   e   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                                   o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                                   c   a   c   h   e   _   p   o   s   i   t   i   o   n   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   l   o   g   i   t   s   _   t   o   _   k   e   e   p   :       U   n   i   o   n   [   i   n   t   ,       t   o   r   c   h   .   T   e   n   s   o   r   ]       =       0   ,   
                                   *   *   k   w   a   r   g   s   :       U   n   p   a   c   k   [   T   r   a   n   s   f   o   r   m   e   r   s   K   w   a   r   g   s   ]   ,   
                   )       -   >       M   o   e   C   a   u   s   a   l   L   M   O   u   t   p   u   t   W   i   t   h   P   a   s   t   :   
                                   r   "   "   "   
                                   l   a   b   e   l   s       (   `   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   `       o   f       s   h   a   p   e       `   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   `   ,       *   o   p   t   i   o   n   a   l   *   )   :   
                                                   L   a   b   e   l   s       f   o   r       c   o   m   p   u   t   i   n   g       t   h   e       m   a   s   k   e   d       l   a   n   g   u   a   g   e       m   o   d   e   l   i   n   g       l   o   s   s   .       I   n   d   i   c   e   s       s   h   o   u   l   d       e   i   t   h   e   r       b   e       i   n       `   [   0   ,       .   .   .   ,   
                                                   c   o   n   f   i   g   .   v   o   c   a   b   _   s   i   z   e   ]   `       o   r       -   1   0   0       (   s   e   e       `   i   n   p   u   t   _   i   d   s   `       d   o   c   s   t   r   i   n   g   )   .       T   o   k   e   n   s       w   i   t   h       i   n   d   i   c   e   s       s   e   t       t   o       `   -   1   0   0   `       a   r   e       i   g   n   o   r   e   d   
                                                   (   m   a   s   k   e   d   )   ,       t   h   e       l   o   s   s       i   s       o   n   l   y       c   o   m   p   u   t   e   d       f   o   r       t   h   e       t   o   k   e   n   s       w   i   t   h       l   a   b   e   l   s       i   n       `   [   0   ,       .   .   .   ,       c   o   n   f   i   g   .   v   o   c   a   b   _   s   i   z   e   ]   `   .   
                                   "   "   "   
   
                                   o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s       =       (   
                                                   o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s       i   f       o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s       i   s       n   o   t       N   o   n   e       e   l   s   e       s   e   l   f   .   c   o   n   f   i   g   .   o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s   
                                   )   
   
                                   #       d   e   c   o   d   e   r       o   u   t   p   u   t   s       c   o   n   s   i   s   t   s       o   f       (   d   e   c   _   f   e   a   t   u   r   e   s   ,       l   a   y   e   r   _   s   t   a   t   e   ,       d   e   c   _   h   i   d   d   e   n   ,       d   e   c   _   a   t   t   n   )   
                                   o   u   t   p   u   t   s   :       M   o   e   M   o   d   e   l   O   u   t   p   u   t   W   i   t   h   P   a   s   t       =       s   e   l   f   .   m   o   d   e   l   (   
                                                   i   n   p   u   t   _   i   d   s   =   i   n   p   u   t   _   i   d   s   ,   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   
                                                   p   o   s   i   t   i   o   n   _   i   d   s   =   p   o   s   i   t   i   o   n   _   i   d   s   ,   
                                                   p   a   s   t   _   k   e   y   _   v   a   l   u   e   s   =   p   a   s   t   _   k   e   y   _   v   a   l   u   e   s   ,   
                                                   i   n   p   u   t   s   _   e   m   b   e   d   s   =   i   n   p   u   t   s   _   e   m   b   e   d   s   ,   
                                                   u   s   e   _   c   a   c   h   e   =   u   s   e   _   c   a   c   h   e   ,   
                                                   o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s   =   o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s   ,   
                                                   c   a   c   h   e   _   p   o   s   i   t   i   o   n   =   c   a   c   h   e   _   p   o   s   i   t   i   o   n   ,   
                                                   *   *   k   w   a   r   g   s   ,   
                                   )   
   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       o   u   t   p   u   t   s   .   l   a   s   t   _   h   i   d   d   e   n   _   s   t   a   t   e   
                                   #       O   n   l   y       c   o   m   p   u   t   e       n   e   c   e   s   s   a   r   y       l   o   g   i   t   s   ,       a   n   d       d   o       n   o   t       u   p   c   a   s   t       t   h   e   m       t   o       f   l   o   a   t       i   f       w   e       a   r   e       n   o   t       c   o   m   p   u   t   i   n   g       t   h   e       l   o   s   s   
                                   s   l   i   c   e   _   i   n   d   i   c   e   s       =       s   l   i   c   e   (   -   l   o   g   i   t   s   _   t   o   _   k   e   e   p   ,       N   o   n   e   )       i   f       i   s   i   n   s   t   a   n   c   e   (   l   o   g   i   t   s   _   t   o   _   k   e   e   p   ,       i   n   t   )       e   l   s   e       l   o   g   i   t   s   _   t   o   _   k   e   e   p   
                                   l   o   g   i   t   s       =       s   e   l   f   .   l   m   _   h   e   a   d   (   h   i   d   d   e   n   _   s   t   a   t   e   s   [   :   ,       s   l   i   c   e   _   i   n   d   i   c   e   s   ,       :   ]   )   
   
                                   l   o   s   s       =       N   o   n   e   
                                   i   f       l   a   b   e   l   s       i   s       n   o   t       N   o   n   e   :   
                                                   l   o   s   s       =       s   e   l   f   .   l   o   s   s   _   f   u   n   c   t   i   o   n   (   l   o   g   i   t   s   ,       l   a   b   e   l   s   ,       s   e   l   f   .   v   o   c   a   b   _   s   i   z   e   ,       *   *   k   w   a   r   g   s   )   
   
                                   a   u   x   _   l   o   s   s       =       N   o   n   e   
                                   i   f       o   u   t   p   u   t   _   r   o   u   t   e   r   _   l   o   g   i   t   s   :   
                                                   a   u   x   _   l   o   s   s       =       l   o   a   d   _   b   a   l   a   n   c   i   n   g   _   l   o   s   s   _   f   u   n   c   (   
                                                                   o   u   t   p   u   t   s   .   r   o   u   t   e   r   _   l   o   g   i   t   s   ,   
                                                                   s   e   l   f   .   n   u   m   _   e   x   p   e   r   t   s   ,   
                                                                   s   e   l   f   .   n   u   m   _   e   x   p   e   r   t   s   _   p   e   r   _   t   o   k   ,   
                                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   
                                                   )   
                                                   i   f       l   a   b   e   l   s       i   s       n   o   t       N   o   n   e   :   
                                                                   l   o   s   s       +   =       s   e   l   f   .   r   o   u   t   e   r   _   a   u   x   _   l   o   s   s   _   c   o   e   f       *       a   u   x   _   l   o   s   s   .   t   o   (   l   o   s   s   .   d   e   v   i   c   e   )           #       m   a   k   e       s   u   r   e       t   o       r   e   s   i   d   e       i   n       t   h   e       s   a   m   e       d   e   v   i   c   e   
   
                                   r   e   t   u   r   n       M   o   e   C   a   u   s   a   l   L   M   O   u   t   p   u   t   W   i   t   h   P   a   s   t   (   
                                                   l   o   s   s   =   l   o   s   s   ,   
                                                   a   u   x   _   l   o   s   s   =   a   u   x   _   l   o   s   s   ,   
                                                   l   o   g   i   t   s   =   l   o   g   i   t   s   ,   
                                                   p   a   s   t   _   k   e   y   _   v   a   l   u   e   s   =   o   u   t   p   u   t   s   .   p   a   s   t   _   k   e   y   _   v   a   l   u   e   s   ,   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   =   o   u   t   p   u   t   s   .   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   a   t   t   e   n   t   i   o   n   s   =   o   u   t   p   u   t   s   .   a   t   t   e   n   t   i   o   n   s   ,   
                                                   r   o   u   t   e   r   _   l   o   g   i   t   s   =   o   u   t   p   u   t   s   .   r   o   u   t   e   r   _   l   o   g   i   t   s   ,   
                                   )   
   
   
   _   _   a   l   l   _   _       =       [   "   E   r   n   i   e   4   _   5   _   M   o   e   F   o   r   C   a   u   s   a   l   L   M   "   ,       "   E   r   n   i   e   4   _   5   _   M   o   e   M   o   d   e   l   "   ,       "   E   r   n   i   e   4   _   5   _   M   o   e   P   r   e   T   r   a   i   n   e   d   M   o   d   e   l   "   ]   
       a   d   i   e   n   t   C   h   e   c   k   p   o   i   n   t   i   n   g   L   a   y   e   r   )   :   
                   "   "   "   C   o   n   f   o   r   m   e   r       b   l   o   c   k       b   a   s   e   d       o   n       h   t   t   p   s   :   /   /   h   u   g   g   i   n   g   f   a   c   e   .   c   o   /   p   a   p   e   r   s   /   2   0   0   5   .   0   8   1   0   0   .   "   "   "   
   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   )   
                                   e   m   b   e   d   _   d   i   m       =       c   o   n   f   i   g   .   h   i   d   d   e   n   _   s   i   z   e   
                                   d   r   o   p   o   u   t       =       c   o   n   f   i   g   .   a   t   t   e   n   t   i   o   n   _   d   r   o   p   o   u   t   
   
                                   #       F   e   e   d   -   f   o   r   w   a   r   d       1   
                                   s   e   l   f   .   f   f       1   _   l   a   y   e   r   _   n   o   r   m       =       n   n   .   L   a   y   e   r   N   o   r   m   (   e   m   b   e   d   _   d   i   m   )   
                                   s   e   l   f   .   f   f   n   1       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   e   e   d   F   o   r   w   a   r   d   (   c   o   n   f   i   g   )   
   
                                   #       S   e   l   f   -   A   t   t   e   n   t   i   o   n   
                                   s   e   l   f   .   s   e   l   f   _   a   t   t   n   _   l   a   y   e   r   _   n   o   r   m       =       n   n   .   L   a   y   e   r   N   o   r   m   (   e   m   b   e   d   _   d   i   m   )   
                                   s   e   l   f   .   s   e   l   f   _   a   t   t   n   _   d   r   o   p   o   u   t       =       n   n   .   D   r   o   p   o   u   t   (   d   r   o   p   o   u   t   )   
                                   s   e   l   f   .   s   e   l   f   _   a   t   t   n       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   S   e   l   f   A   t   t   e   n   t   i   o   n   (   c   o   n   f   i   g   )   
   
                                   #       C   o   n   f   o   r   m   e   r       C   o   n   v   o   l   u   t   i   o   n   
                                   s   e   l   f   .   c   o   n   v   _   m   o   d   u   l   e       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   C   o   n   v   o   l   u   t   i   o   n   M   o   d   u   l   e   (   c   o   n   f   i   g   )   
   
                                   #       F   e   e   d   -   f   o   r   w   a   r   d       2   
                                   s   e   l   f   .   f   f   n   2   _   l   a   y   e   r   _   n   o   r   m       =       n   n   .   L   a   y   e   r   N   o   r   m   (   e   m   b   e   d   _   d   i   m   )   
                                   s   e   l   f   .   f   f   n   2       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   e   e   d   F   o   r   w   a   r   d   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   f   i   n   a   l   _   l   a   y   e   r   _   n   o   r   m       =       n   n   .   L   a   y   e   r   N   o   r   m   (   e   m   b   e   d   _   d   i   m   )   
   
                   d   e   f       f   o   r   w   a   r   d   (   
                                   s   e   l   f   ,   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   r   e   l   a   t   i   v   e   _   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   :       b   o   o   l       =       F   a   l   s   e   ,   
                   )   :   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s   
   
                                   #       1   .       F   e   e   d   -   F   o   r   w   a   r   d       1       l   a   y   e   r   
                                   r   e   s   i   d   u   a   l       =       h   i   d   d   e   n   _   s   t   a   t   e   s   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   f   f   n   1   _   l   a   y   e   r   _   n   o   r   m   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   f   f   n   1   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s       *       0   .   5       +       r   e   s   i   d   u   a   l   
                                   r   e   s   i   d   u   a   l       =       h   i   d   d   e   n   _   s   t   a   t   e   s   
   
                                   #       2   .       S   e   l   f   -   A   t   t   e   n   t   i   o   n       l   a   y   e   r   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   s   e   l   f   _   a   t   t   n   _   l   a   y   e   r   _   n   o   r   m   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s   ,       a   t   t   n   _   w   e   i   g   t   s       =       s   e   l   f   .   s   e   l   f   _   a   t   t   n   (   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   =   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   
                                                   r   e   l   a   t   i   v   e   _   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s   =   r   e   l   a   t   i   v   e   _   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s   ,   
                                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   =   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   ,   
                                   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   s   e   l   f   _   a   t   t   n   _   d   r   o   p   o   u   t   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s       +       r   e   s   i   d   u   a   l   
   
                                   #       3   .       C   o   n   v   o   l   u   t   i   o   n   a   l       L   a   y   e   r   
                                   r   e   s   i   d   u   a   l       =       h   i   d   d   e   n   _   s   t   a   t   e   s   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   c   o   n   v   _   m   o   d   u   l   e   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       r   e   s   i   d   u   a   l       +       h   i   d   d   e   n   _   s   t   a   t   e   s   
   
                                   #       4   .       F   e   e   d   -   F   o   r   w   a   r   d       2       L   a   y   e   r   
                                   r   e   s   i   d   u   a   l       =       h   i   d   d   e   n   _   s   t   a   t   e   s   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   f   f   n   2   _   l   a   y   e   r   _   n   o   r   m   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   f   f   n   2   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s       *       0   .   5       +       r   e   s   i   d   u   a   l   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   f   i   n   a   l   _   l   a   y   e   r   _   n   o   r   m   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
   
                                   r   e   t   u   r   n       h   i   d   d   e   n   _   s   t   a   t   e   s   ,       a   t   t   n   _   w   e   i   g   t   s   
   
   
   c   l   a   s   s       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   E   n   c   o   d   e   r   (   n   n   .   M   o   d   u   l   e   )   :   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   )   
                                   s   e   l   f   .   c   o   n   f   i   g       =       c   o   n   f   i   g   
   
                                   i   f       c   o   n   f   i   g   .   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s   _   t   y   p   e       =   =       "   r   e   l   a   t   i   v   e   "   :   
                                                   s   e   l   f   .   e   m   b   e   d   _   p   o   s   i   t   i   o   n   s       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   R   e   l   P   o   s   i   t   i   o   n   a   l   E   m   b   e   d   d   i   n   g   (   c   o   n   f   i   g   )   
                                   e   l   i   f       c   o   n   f   i   g   .   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s   _   t   y   p   e       =   =       "   r   o   t   a   r   y   "   :   
                                                   s   e   l   f   .   e   m   b   e   d   _   p   o   s   i   t   i   o   n   s       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   R   o   t   a   r   y   P   o   s   i   t   i   o   n   a   l   E   m   b   e   d   d   i   n   g   (   c   o   n   f   i   g   )   
                                   e   l   s   e   :   
                                                   s   e   l   f   .   e   m   b   e   d   _   p   o   s   i   t   i   o   n   s       =       N   o   n   e   
   
                                   s   e   l   f   .   p   o   s   _   c   o   n   v   _   e   m   b   e   d       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   P   o   s   i   t   i   o   n   a   l   C   o   n   v   E   m   b   e   d   d   i   n   g   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   l   a   y   e   r   _   n   o   r   m       =       n   n   .   L   a   y   e   r   N   o   r   m   (   c   o   n   f   i   g   .   h   i   d   d   e   n   _   s   i   z   e   ,       e   p   s   =   c   o   n   f   i   g   .   l   a   y   e   r   _   n   o   r   m   _   e   p   s   )   
                                   s   e   l   f   .   d   r   o   p   o   u   t       =       n   n   .   D   r   o   p   o   u   t   (   c   o   n   f   i   g   .   h   i   d   d   e   n   _   d   r   o   p   o   u   t   )   
                                   s   e   l   f   .   l   a   y   e   r   s       =       n   n   .   M   o   d   u   l   e   L   i   s   t   (   [   W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   E   n   c   o   d   e   r   L   a   y   e   r   (   c   o   n   f   i   g   )       f   o   r       _       i   n       r   a   n   g   e   (   c   o   n   f   i   g   .   n   u   m   _   h   i   d   d   e   n   _   l   a   y   e   r   s   )   ]   )   
                                   s   e   l   f   .   g   r   a   d   i   e   n   t   _   c   h   e   c   k   p   o   i   n   t   i   n   g       =       F   a   l   s   e   
   
                   d   e   f       f   o   r   w   a   r   d   (   
                                   s   e   l   f   ,   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   N   o   n   e   ,   
                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   =   F   a   l   s   e   ,   
                                   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   =   F   a   l   s   e   ,   
                                   r   e   t   u   r   n   _   d   i   c   t   =   T   r   u   e   ,   
                   )   :   
                                   a   l   l   _   h   i   d   d   e   n   _   s   t   a   t   e   s       =       (   )       i   f       o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s       e   l   s   e       N   o   n   e   
                                   a   l   l   _   s   e   l   f   _   a   t   t   e   n   t   i   o   n   s       =       (   )       i   f       o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s       e   l   s   e       N   o   n   e   
   
                                   i   f       a   t   t   e   n   t   i   o   n   _   m   a   s   k       i   s       n   o   t       N   o   n   e   :   
                                                   #       m   a   k   e       s   u   r   e       p   a   d   d   e   d       t   o   k   e   n   s       o   u   t   p   u   t       0   
                                                   e   x   p   a   n   d   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   u   n   s   q   u   e   e   z   e   (   -   1   )   .   r   e   p   e   a   t   (   1   ,       1   ,       h   i   d   d   e   n   _   s   t   a   t   e   s   .   s   h   a   p   e   [   2   ]   )   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   [   ~   e   x   p   a   n   d   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ]       =       0   .   0   
   
                                                   #       e   x   t   e   n   d       a   t   t   e   n   t   i   o   n   _   m   a   s   k   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       1   .   0       -       a   t   t   e   n   t   i   o   n   _   m   a   s   k   [   :   ,       N   o   n   e   ,       N   o   n   e   ,       :   ]   .   t   o   (   d   t   y   p   e   =   h   i   d   d   e   n   _   s   t   a   t   e   s   .   d   t   y   p   e   )   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       a   t   t   e   n   t   i   o   n   _   m   a   s   k       *       t   o   r   c   h   .   f   i   n   f   o   (   h   i   d   d   e   n   _   s   t   a   t   e   s   .   d   t   y   p   e   )   .   m   i   n   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   e   x   p   a   n   d   (   
                                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   s   h   a   p   e   [   0   ]   ,       1   ,       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   s   h   a   p   e   [   -   1   ]   ,       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   s   h   a   p   e   [   -   1   ]   
                                                   )   
   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   d   r   o   p   o   u   t   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
   
                                   i   f       s   e   l   f   .   e   m   b   e   d   _   p   o   s   i   t   i   o   n   s       i   s       n   o   t       N   o   n   e   :   
                                                   r   e   l   a   t   i   v   e   _   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s       =       s   e   l   f   .   e   m   b   e   d   _   p   o   s   i   t   i   o   n   s   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   e   l   s   e   :   
                                                   r   e   l   a   t   i   v   e   _   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s       =       N   o   n   e   
   
                                   s   y   n   c   e   d   _   g   p   u   s       =       i   s   _   d   e   e   p   s   p   e   e   d   _   z   e   r   o   3   _   e   n   a   b   l   e   d   (   )       o   r       i   s   _   f   s   d   p   _   m   a   n   a   g   e   d   _   m   o   d   u   l   e   (   s   e   l   f   )   
   
                                   f   o   r       i   ,       l   a   y   e   r       i   n       e   n   u   m   e   r   a   t   e   (   s   e   l   f   .   l   a   y   e   r   s   )   :   
                                                   i   f       o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   :   
                                                                   a   l   l   _   h   i   d   d   e   n   _   s   t   a   t   e   s       =       a   l   l   _   h   i   d   d   e   n   _   s   t   a   t   e   s       +       (   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   )   
   
                                                   #       a   d   d       L   a   y   e   r   D   r   o   p       (   s   e   e       h   t   t   p   s   :   /   /   h   u   g   g   i   n   g   f   a   c   e   .   c   o   /   p   a   p   e   r   s   /   1   9   0   9   .   1   1   5   5   6       f   o   r       d   e   s   c   r   i   p   t   i   o   n   )   
                                                   d   r   o   p   o   u   t   _   p   r   o   b   a   b   i   l   i   t   y       =       t   o   r   c   h   .   r   a   n   d   (   [   ]   )   
   
                                                   s   k   i   p   _   t   h   e   _   l   a   y   e   r       =       s   e   l   f   .   t   r   a   i   n   i   n   g       a   n   d       d   r   o   p   o   u   t   _   p   r   o   b   a   b   i   l   i   t   y       <       s   e   l   f   .   c   o   n   f   i   g   .   l   a   y   e   r   d   r   o   p   
                                                   i   f       n   o   t       s   k   i   p   _   t   h   e   _   l   a   y   e   r       o   r       s   y   n   c   e   d   _   g   p   u   s   :   
                                                                   #       u   n   d   e   r       f   s   d   p       o   r       d   e   e   p   s   p   e   e   d       z   e   r   o   3       a   l   l       g   p   u   s       m   u   s   t       r   u   n       i   n       s   y   n   c   
                                                                   l   a   y   e   r   _   o   u   t   p   u   t   s       =       l   a   y   e   r   (   
                                                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   
                                                                                   r   e   l   a   t   i   v   e   _   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s   =   r   e   l   a   t   i   v   e   _   p   o   s   i   t   i   o   n   _   e   m   b   e   d   d   i   n   g   s   ,   
                                                                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   =   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   ,   
                                                                   )   
                                                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       l   a   y   e   r   _   o   u   t   p   u   t   s   [   0   ]   
   
                                                   i   f       s   k   i   p   _   t   h   e   _   l   a   y   e   r   :   
                                                                   l   a   y   e   r   _   o   u   t   p   u   t   s       =       (   N   o   n   e   ,       N   o   n   e   )   
   
                                                   i   f       o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   :   
                                                                   a   l   l   _   s   e   l   f   _   a   t   t   e   n   t   i   o   n   s       =       a   l   l   _   s   e   l   f   _   a   t   t   e   n   t   i   o   n   s       +       (   l   a   y   e   r   _   o   u   t   p   u   t   s   [   1   ]   ,   )   
   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   l   a   y   e   r   _   n   o   r   m   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   i   f       o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   :   
                                                   a   l   l   _   h   i   d   d   e   n   _   s   t   a   t   e   s       =       a   l   l   _   h   i   d   d   e   n   _   s   t   a   t   e   s       +       (   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   )   
   
                                   i   f       n   o   t       r   e   t   u   r   n   _   d   i   c   t   :   
                                                   r   e   t   u   r   n       t   u   p   l   e   (   v       f   o   r       v       i   n       [   h   i   d   d   e   n   _   s   t   a   t   e   s   ,       a   l   l   _   h   i   d   d   e   n   _   s   t   a   t   e   s   ,       a   l   l   _   s   e   l   f   _   a   t   t   e   n   t   i   o   n   s   ]       i   f       v       i   s       n   o   t       N   o   n   e   )   
                                   r   e   t   u   r   n       B   a   s   e   M   o   d   e   l   O   u   t   p   u   t   (   
                                                   l   a   s   t   _   h   i   d   d   e   n   _   s   t   a   t   e   =   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   =   a   l   l   _   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   a   t   t   e   n   t   i   o   n   s   =   a   l   l   _   s   e   l   f   _   a   t   t   e   n   t   i   o   n   s   ,   
                                   )   
   
   
   c   l   a   s   s       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   G   u   m   b   e   l   V   e   c   t   o   r   Q   u   a   n   t   i   z   e   r   (   n   n   .   M   o   d   u   l   e   )   :   
                   "   "   "   
                   V   e   c   t   o   r       q   u   a   n   t   i   z   a   t   i   o   n       u   s   i   n   g       g   u   m   b   e   l       s   o   f   t   m   a   x   .       S   e   e       `   [   C   A   T   E   G   O   R   I   C   A   L       R   E   P   A   R   A   M   E   T   E   R   I   Z   A   T   I   O   N       W   I   T   H   
                   G   U   M   B   E   L   -   S   O   F   T   M   A   X   ]   (   h   t   t   p   s   :   /   /   h   u   g   g   i   n   g   f   a   c   e   .   c   o   /   p   a   p   e   r   s   /   1   6   1   1   .   0   1   1   4   4   )       f   o   r       m   o   r   e       i   n   f   o   r   m   a   t   i   o   n   .   
                   "   "   "   
   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   )   
                                   s   e   l   f   .   n   u   m   _   g   r   o   u   p   s       =       c   o   n   f   i   g   .   n   u   m   _   c   o   d   e   v   e   c   t   o   r   _   g   r   o   u   p   s   
                                   s   e   l   f   .   n   u   m   _   v   a   r   s       =       c   o   n   f   i   g   .   n   u   m   _   c   o   d   e   v   e   c   t   o   r   s   _   p   e   r   _   g   r   o   u   p   
   
                                   i   f       c   o   n   f   i   g   .   c   o   d   e   v   e   c   t   o   r   _   d   i   m       %       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s       !   =       0   :   
                                                   r   a   i   s   e       V   a   l   u   e   E   r   r   o   r   (   
                                                                   f   "   `   c   o   n   f   i   g   .   c   o   d   e   v   e   c   t   o   r   _   d   i   m       {   c   o   n   f   i   g   .   c   o   d   e   v   e   c   t   o   r   _   d   i   m   }       m   u   s   t       b   e       d   i   v   i   s   i   b   l   e       "   
                                                                   f   "   b   y       `   c   o   n   f   i   g   .   n   u   m   _   c   o   d   e   v   e   c   t   o   r   _   g   r   o   u   p   s   `       {   s   e   l   f   .   n   u   m   _   g   r   o   u   p   s   }       f   o   r       c   o   n   c   a   t   e   n   a   t   i   o   n   "   
                                                   )   
   
                                   #       s   t   o   r   a   g   e       f   o   r       c   o   d   e   b   o   o   k       v   a   r   i   a   b   l   e   s       (   c   o   d   e   w   o   r   d   s   )   
                                   s   e   l   f   .   c   o   d   e   v   e   c   t   o   r   s       =       n   n   .   P   a   r   a   m   e   t   e   r   (   
                                                   t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   (   1   ,       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s       *       s   e   l   f   .   n   u   m   _   v   a   r   s   ,       c   o   n   f   i   g   .   c   o   d   e   v   e   c   t   o   r   _   d   i   m       /   /       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s   )   
                                   )   
                                   s   e   l   f   .   w   e   i   g   h   t   _   p   r   o   j       =       n   n   .   L   i   n   e   a   r   (   c   o   n   f   i   g   .   c   o   n   v   _   d   i   m   [   -   1   ]   ,       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s       *       s   e   l   f   .   n   u   m   _   v   a   r   s   )   
   
                                   #       c   a   n       b   e       d   e   c   a   y   e   d       f   o   r       t   r   a   i   n   i   n   g   
                                   s   e   l   f   .   t   e   m   p   e   r   a   t   u   r   e       =       2   
   
                   @   s   t   a   t   i   c   m   e   t   h   o   d   
                   d   e   f       _   c   o   m   p   u   t   e   _   p   e   r   p   l   e   x   i   t   y   (   p   r   o   b   s   ,       m   a   s   k   =   N   o   n   e   )   :   
                                   i   f       m   a   s   k       i   s       n   o   t       N   o   n   e   :   
                                                   m   a   s   k   _   e   x   t   e   n   d   e   d       =       m   a   s   k   .   f   l   a   t   t   e   n   (   )   [   :   ,       N   o   n   e   ,       N   o   n   e   ]   .   e   x   p   a   n   d   (   p   r   o   b   s   .   s   h   a   p   e   )   
                                                   p   r   o   b   s       =       t   o   r   c   h   .   w   h   e   r   e   (   m   a   s   k   _   e   x   t   e   n   d   e   d   ,       p   r   o   b   s   ,       t   o   r   c   h   .   z   e   r   o   s   _   l   i   k   e   (   p   r   o   b   s   )   )   
                                                   m   a   r   g   i   n   a   l   _   p   r   o   b   s       =       p   r   o   b   s   .   s   u   m   (   d   i   m   =   0   )       /       m   a   s   k   .   s   u   m   (   )   
                                   e   l   s   e   :   
                                                   m   a   r   g   i   n   a   l   _   p   r   o   b   s       =       p   r   o   b   s   .   m   e   a   n   (   d   i   m   =   0   )   
   
                                   p   e   r   p   l   e   x   i   t   y       =       t   o   r   c   h   .   e   x   p   (   -   t   o   r   c   h   .   s   u   m   (   m   a   r   g   i   n   a   l   _   p   r   o   b   s       *       t   o   r   c   h   .   l   o   g   (   m   a   r   g   i   n   a   l   _   p   r   o   b   s       +       1   e   -   7   )   ,       d   i   m   =   -   1   )   )   .   s   u   m   (   )   
                                   r   e   t   u   r   n       p   e   r   p   l   e   x   i   t   y   
   
                   d   e   f       f   o   r   w   a   r   d   (   s   e   l   f   ,       h   i   d   d   e   n   _   s   t   a   t   e   s   ,       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   =   N   o   n   e   )   :   
                                   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       h   i   d   d   e   n   _   s   i   z   e       =       h   i   d   d   e   n   _   s   t   a   t   e   s   .   s   h   a   p   e   
   
                                   #       p   r   o   j   e   c   t       t   o       c   o   d   e   v   e   c   t   o   r       d   i   m   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   w   e   i   g   h   t   _   p   r   o   j   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s   .   v   i   e   w   (   b   a   t   c   h   _   s   i   z   e       *       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       *       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s   ,       -   1   )   
   
                                   i   f       s   e   l   f   .   t   r   a   i   n   i   n   g   :   
                                                   #       s   a   m   p   l   e       c   o   d   e       v   e   c   t   o   r       p   r   o   b   s       v   i   a       g   u   m   b   e   l       i   n       d   i   f   f   e   r   e   n   t   i   a   t   e   a   b   l   e       w   a   y   
                                                   c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s       =       n   n   .   f   u   n   c   t   i   o   n   a   l   .   g   u   m   b   e   l   _   s   o   f   t   m   a   x   (   
                                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   .   f   l   o   a   t   (   )   ,       t   a   u   =   s   e   l   f   .   t   e   m   p   e   r   a   t   u   r   e   ,       h   a   r   d   =   T   r   u   e   
                                                   )   .   t   y   p   e   _   a   s   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
   
                                                   #       c   o   m   p   u   t   e       p   e   r   p   l   e   x   i   t   y   
                                                   c   o   d   e   v   e   c   t   o   r   _   s   o   f   t   _   d   i   s   t       =       t   o   r   c   h   .   s   o   f   t   m   a   x   (   
                                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   .   v   i   e   w   (   b   a   t   c   h   _   s   i   z   e       *       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s   ,       -   1   )   .   f   l   o   a   t   (   )   ,       d   i   m   =   -   1   
                                                   )   
                                                   p   e   r   p   l   e   x   i   t   y       =       s   e   l   f   .   _   c   o   m   p   u   t   e   _   p   e   r   p   l   e   x   i   t   y   (   c   o   d   e   v   e   c   t   o   r   _   s   o   f   t   _   d   i   s   t   ,       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   )   
                                   e   l   s   e   :   
                                                   #       t   a   k   e       a   r   g   m   a   x       i   n       n   o   n   -   d   i   f   f   e   r   e   n   t   i   a   b   l   e       w   a   y   
                                                   #       c   o   m   p   t   u   t   e       h   a   r   d       c   o   d   e   v   e   c   t   o   r       d   i   s   t   r   i   b   u   t   i   o   n       (   o   n   e       h   o   t   )   
                                                   c   o   d   e   v   e   c   t   o   r   _   i   d   x       =       h   i   d   d   e   n   _   s   t   a   t   e   s   .   a   r   g   m   a   x   (   d   i   m   =   -   1   )   
                                                   c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s   .   n   e   w   _   z   e   r   o   s   (   h   i   d   d   e   n   _   s   t   a   t   e   s   .   s   h   a   p   e   )   .   s   c   a   t   t   e   r   _   (   
                                                                   -   1   ,       c   o   d   e   v   e   c   t   o   r   _   i   d   x   .   v   i   e   w   (   -   1   ,       1   )   ,       1   .   0   
                                                   )   
                                                   c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s       =       c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s   .   v   i   e   w   (   b   a   t   c   h   _   s   i   z   e       *       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s   ,       -   1   )   
   
                                                   p   e   r   p   l   e   x   i   t   y       =       s   e   l   f   .   _   c   o   m   p   u   t   e   _   p   e   r   p   l   e   x   i   t   y   (   c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s   ,       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   )   
   
                                   c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s       =       c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s   .   v   i   e   w   (   b   a   t   c   h   _   s   i   z   e       *       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       -   1   )   
                                   #       u   s   e       p   r   o   b   s       t   o       r   e   t   r   i   e   v   e       c   o   d   e   v   e   c   t   o   r   s   
                                   c   o   d   e   v   e   c   t   o   r   s   _   p   e   r   _   g   r   o   u   p       =       c   o   d   e   v   e   c   t   o   r   _   p   r   o   b   s   .   u   n   s   q   u   e   e   z   e   (   -   1   )       *       s   e   l   f   .   c   o   d   e   v   e   c   t   o   r   s   
                                   c   o   d   e   v   e   c   t   o   r   s       =       c   o   d   e   v   e   c   t   o   r   s   _   p   e   r   _   g   r   o   u   p   .   v   i   e   w   (   b   a   t   c   h   _   s   i   z   e       *       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       s   e   l   f   .   n   u   m   _   g   r   o   u   p   s   ,       s   e   l   f   .   n   u   m   _   v   a   r   s   ,       -   1   )   
                                   c   o   d   e   v   e   c   t   o   r   s       =       c   o   d   e   v   e   c   t   o   r   s   .   s   u   m   (   -   2   )   .   v   i   e   w   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       -   1   )   
   
                                   r   e   t   u   r   n       c   o   d   e   v   e   c   t   o   r   s   ,       p   e   r   p   l   e   x   i   t   y   
   
   
   c   l   a   s   s       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   A   d   a   p   t   e   r   (   n   n   .   M   o   d   u   l   e   )   :   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   )   
   
                                   #       f   e   a   t   u   r   e       d   i   m       m   i   g   h   t       n   e   e   d       t   o       b   e       d   o   w   n   -   p   r   o   j   e   c   t   e   d   
                                   i   f       c   o   n   f   i   g   .   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   i   z   e       !   =       c   o   n   f   i   g   .   h   i   d   d   e   n   _   s   i   z   e   :   
                                                   s   e   l   f   .   p   r   o   j       =       n   n   .   L   i   n   e   a   r   (   c   o   n   f   i   g   .   h   i   d   d   e   n   _   s   i   z   e   ,       c   o   n   f   i   g   .   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   i   z   e   )   
                                                   s   e   l   f   .   p   r   o   j   _   l   a   y   e   r   _   n   o   r   m       =       n   n   .   L   a   y   e   r   N   o   r   m   (   c   o   n   f   i   g   .   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   i   z   e   )   
                                   e   l   s   e   :   
                                                   s   e   l   f   .   p   r   o   j       =       s   e   l   f   .   p   r   o   j   _   l   a   y   e   r   _   n   o   r   m       =       N   o   n   e   
   
                                   s   e   l   f   .   l   a   y   e   r   s       =       n   n   .   M   o   d   u   l   e   L   i   s   t   (   W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   A   d   a   p   t   e   r   L   a   y   e   r   (   c   o   n   f   i   g   )       f   o   r       _       i   n       r   a   n   g   e   (   c   o   n   f   i   g   .   n   u   m   _   a   d   a   p   t   e   r   _   l   a   y   e   r   s   )   )   
                                   s   e   l   f   .   l   a   y   e   r   d   r   o   p       =       c   o   n   f   i   g   .   l   a   y   e   r   d   r   o   p   
   
                   d   e   f       f   o   r   w   a   r   d   (   s   e   l   f   ,       h   i   d   d   e   n   _   s   t   a   t   e   s   )   :   
                                   #       d   o   w   n       p   r   o   j   e   c   t       h   i   d   d   e   n   _   s   t   a   t   e   s       i   f       n   e   c   e   s   s   a   r   y   
                                   i   f       s   e   l   f   .   p   r   o   j       i   s       n   o   t       N   o   n   e       a   n   d       s   e   l   f   .   p   r   o   j   _   l   a   y   e   r   _   n   o   r   m       i   s       n   o   t       N   o   n   e   :   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   p   r   o   j   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   p   r   o   j   _   l   a   y   e   r   _   n   o   r   m   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s   .   t   r   a   n   s   p   o   s   e   (   1   ,       2   )   
   
                                   f   o   r       l   a   y   e   r       i   n       s   e   l   f   .   l   a   y   e   r   s   :   
                                                   l   a   y   e   r   d   r   o   p   _   p   r   o   b       =       n   p   .   r   a   n   d   o   m   .   r   a   n   d   o   m   (   )   
                                                   i   f       n   o   t       s   e   l   f   .   t   r   a   i   n   i   n   g       o   r       (   l   a   y   e   r   d   r   o   p   _   p   r   o   b       >       s   e   l   f   .   l   a   y   e   r   d   r   o   p   )   :   
                                                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       l   a   y   e   r   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       h   i   d   d   e   n   _   s   t   a   t   e   s   .   t   r   a   n   s   p   o   s   e   (   1   ,       2   )   
                                   r   e   t   u   r   n       h   i   d   d   e   n   _   s   t   a   t   e   s   
   
   
   c   l   a   s   s       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   A   d   a   p   t   e   r   L   a   y   e   r   (   n   n   .   M   o   d   u   l   e   )   :   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   )   
                                   s   e   l   f   .   c   o   n   v       =       n   n   .   C   o   n   v   1   d   (   
                                                   c   o   n   f   i   g   .   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   i   z   e   ,   
                                                   2       *       c   o   n   f   i   g   .   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   i   z   e   ,   
                                                   c   o   n   f   i   g   .   a   d   a   p   t   e   r   _   k   e   r   n   e   l   _   s   i   z   e   ,   
                                                   s   t   r   i   d   e   =   c   o   n   f   i   g   .   a   d   a   p   t   e   r   _   s   t   r   i   d   e   ,   
                                                   p   a   d   d   i   n   g   =   1   ,   
                                   )   
   
                   d   e   f       f   o   r   w   a   r   d   (   s   e   l   f   ,       h   i   d   d   e   n   _   s   t   a   t   e   s   )   :   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   c   o   n   v   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       n   n   .   f   u   n   c   t   i   o   n   a   l   .   g   l   u   (   h   i   d   d   e   n   _   s   t   a   t   e   s   ,       d   i   m   =   1   )   
   
                                   r   e   t   u   r   n       h   i   d   d   e   n   _   s   t   a   t   e   s   
   
   
   @   a   u   t   o   _   d   o   c   s   t   r   i   n   g   
   c   l   a   s   s       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   P   r   e   T   r   a   i   n   e   d   M   o   d   e   l   (   P   r   e   T   r   a   i   n   e   d   M   o   d   e   l   )   :   
                   c   o   n   f   i   g   :       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   C   o   n   f   i   g   
                   b   a   s   e   _   m   o   d   e   l   _   p   r   e   f   i   x       =       "   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r   "   
                   m   a   i   n   _   i   n   p   u   t   _   n   a   m   e       =       "   i   n   p   u   t   _   v   a   l   u   e   s   "   
                   s   u   p   p   o   r   t   s   _   g   r   a   d   i   e   n   t   _   c   h   e   c   k   p   o   i   n   t   i   n   g       =       T   r   u   e   
   
                   d   e   f       _   i   n   i   t   _   w   e   i   g   h   t   s   (   s   e   l   f   ,       m   o   d   u   l   e   )   :   
                                   "   "   "   I   n   i   t   i   a   l   i   z   e       t   h   e       w   e   i   g   h   t   s   "   "   "   
                                   #       W   a   v   2   V   e   c   2   F   o   r   P   r   e   T   r   a   i   n   i   n   g       l   a   s   t       2       l   i   n   e   a   r       l   a   y   e   r   s       n   e   e   d       s   t   a   n   d   a   r   d       L   i   n   e   a   r       i   n   i   t   .   
                                   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   o   r   P   r   e   T   r   a   i   n   i   n   g   )   :   
                                                   m   o   d   u   l   e   .   p   r   o   j   e   c   t   _   h   i   d   .   r   e   s   e   t   _   p   a   r   a   m   e   t   e   r   s   (   )   
                                                   m   o   d   u   l   e   .   p   r   o   j   e   c   t   _   q   .   r   e   s   e   t   _   p   a   r   a   m   e   t   e   r   s   (   )   
                                                   m   o   d   u   l   e   .   p   r   o   j   e   c   t   _   h   i   d   .   _   i   s   _   h   f   _   i   n   i   t   i   a   l   i   z   e   d       =       T   r   u   e   
                                                   m   o   d   u   l   e   .   p   r   o   j   e   c   t   _   q   .   _   i   s   _   h   f   _   i   n   i   t   i   a   l   i   z   e   d       =       T   r   u   e   
                                   #       g   u   m   b   e   l       s   o   f   t   m   a   x       r   e   q   u   i   r   e   s       s   p   e   c   i   a   l       i   n   i   t   
                                   e   l   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   G   u   m   b   e   l   V   e   c   t   o   r   Q   u   a   n   t   i   z   e   r   )   :   
                                                   m   o   d   u   l   e   .   w   e   i   g   h   t   _   p   r   o   j   .   w   e   i   g   h   t   .   d   a   t   a   .   n   o   r   m   a   l   _   (   m   e   a   n   =   0   .   0   ,       s   t   d   =   1   )   
                                                   m   o   d   u   l   e   .   w   e   i   g   h   t   _   p   r   o   j   .   b   i   a   s   .   d   a   t   a   .   z   e   r   o   _   (   )   
                                                   n   n   .   i   n   i   t   .   u   n   i   f   o   r   m   _   (   m   o   d   u   l   e   .   c   o   d   e   v   e   c   t   o   r   s   )   
                                   e   l   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   S   e   l   f   A   t   t   e   n   t   i   o   n   )   :   
                                                   i   f       h   a   s   a   t   t   r   (   m   o   d   u   l   e   ,       "   p   o   s   _   b   i   a   s   _   u   "   )   :   
                                                                   n   n   .   i   n   i   t   .   x   a   v   i   e   r   _   u   n   i   f   o   r   m   _   (   m   o   d   u   l   e   .   p   o   s   _   b   i   a   s   _   u   )   
                                                   i   f       h   a   s   a   t   t   r   (   m   o   d   u   l   e   ,       "   p   o   s   _   b   i   a   s   _   v   "   )   :   
                                                                   n   n   .   i   n   i   t   .   x   a   v   i   e   r   _   u   n   i   f   o   r   m   _   (   m   o   d   u   l   e   .   p   o   s   _   b   i   a   s   _   v   )   
                                   e   l   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   P   o   s   i   t   i   o   n   a   l   C   o   n   v   E   m   b   e   d   d   i   n   g   )   :   
                                                   n   n   .   i   n   i   t   .   n   o   r   m   a   l   _   (   
                                                                   m   o   d   u   l   e   .   c   o   n   v   .   w   e   i   g   h   t   ,   
                                                                   m   e   a   n   =   0   ,   
                                                                   s   t   d   =   2       *       m   a   t   h   .   s   q   r   t   (   1       /       (   m   o   d   u   l   e   .   c   o   n   v   .   k   e   r   n   e   l   _   s   i   z   e   [   0   ]       *       m   o   d   u   l   e   .   c   o   n   v   .   i   n   _   c   h   a   n   n   e   l   s   )   )   ,   
                                                   )   
                                                   n   n   .   i   n   i   t   .   c   o   n   s   t   a   n   t   _   (   m   o   d   u   l   e   .   c   o   n   v   .   b   i   a   s   ,       0   )   
                                   e   l   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   e   a   t   u   r   e   P   r   o   j   e   c   t   i   o   n   )   :   
                                                   k       =       m   a   t   h   .   s   q   r   t   (   1       /       m   o   d   u   l   e   .   p   r   o   j   e   c   t   i   o   n   .   i   n   _   f   e   a   t   u   r   e   s   )   
                                                   n   n   .   i   n   i   t   .   u   n   i   f   o   r   m   _   (   m   o   d   u   l   e   .   p   r   o   j   e   c   t   i   o   n   .   w   e   i   g   h   t   ,       a   =   -   k   ,       b   =   k   )   
                                                   n   n   .   i   n   i   t   .   u   n   i   f   o   r   m   _   (   m   o   d   u   l   e   .   p   r   o   j   e   c   t   i   o   n   .   b   i   a   s   ,       a   =   -   k   ,       b   =   k   )   
                                   e   l   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       n   n   .   L   i   n   e   a   r   )   :   
                                                   m   o   d   u   l   e   .   w   e   i   g   h   t   .   d   a   t   a   .   n   o   r   m   a   l   _   (   m   e   a   n   =   0   .   0   ,       s   t   d   =   s   e   l   f   .   c   o   n   f   i   g   .   i   n   i   t   i   a   l   i   z   e   r   _   r   a   n   g   e   )   
   
                                                   i   f       m   o   d   u   l   e   .   b   i   a   s       i   s       n   o   t       N   o   n   e   :   
                                                                   m   o   d   u   l   e   .   b   i   a   s   .   d   a   t   a   .   z   e   r   o   _   (   )   
                                   e   l   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       (   n   n   .   L   a   y   e   r   N   o   r   m   ,       n   n   .   G   r   o   u   p   N   o   r   m   )   )   :   
                                                   m   o   d   u   l   e   .   b   i   a   s   .   d   a   t   a   .   z   e   r   o   _   (   )   
                                                   m   o   d   u   l   e   .   w   e   i   g   h   t   .   d   a   t   a   .   f   i   l   l   _   (   1   .   0   )   
                                   e   l   i   f       i   s   i   n   s   t   a   n   c   e   (   m   o   d   u   l   e   ,       n   n   .   C   o   n   v   1   d   )   :   
                                                   n   n   .   i   n   i   t   .   k   a   i   m   i   n   g   _   n   o   r   m   a   l   _   (   m   o   d   u   l   e   .   w   e   i   g   h   t   )   
   
                                                   i   f       m   o   d   u   l   e   .   b   i   a   s       i   s       n   o   t       N   o   n   e   :   
                                                                   k       =       m   a   t   h   .   s   q   r   t   (   m   o   d   u   l   e   .   g   r   o   u   p   s       /       (   m   o   d   u   l   e   .   i   n   _   c   h   a   n   n   e   l   s       *       m   o   d   u   l   e   .   k   e   r   n   e   l   _   s   i   z   e   [   0   ]   )   )   
                                                                   n   n   .   i   n   i   t   .   u   n   i   f   o   r   m   _   (   m   o   d   u   l   e   .   b   i   a   s   ,       a   =   -   k   ,       b   =   k   )   
   
                   d   e   f       _   g   e   t   _   f   e   a   t   _   e   x   t   r   a   c   t   _   o   u   t   p   u   t   _   l   e   n   g   t   h   s   (   
                                   s   e   l   f   ,       i   n   p   u   t   _   l   e   n   g   t   h   s   :       U   n   i   o   n   [   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ,       i   n   t   ]   ,       a   d   d   _   a   d   a   p   t   e   r   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   
                   )   :   
                                   "   "   "   
                                   C   o   m   p   u   t   e   s       t   h   e       o   u   t   p   u   t       l   e   n   g   t   h       o   f       t   h   e       c   o   n   v   o   l   u   t   i   o   n   a   l       l   a   y   e   r   s   
                                   "   "   "   
   
                                   a   d   d   _   a   d   a   p   t   e   r       =       s   e   l   f   .   c   o   n   f   i   g   .   a   d   d   _   a   d   a   p   t   e   r       i   f       a   d   d   _   a   d   a   p   t   e   r       i   s       N   o   n   e       e   l   s   e       a   d   d   _   a   d   a   p   t   e   r   
   
                                   d   e   f       _   c   o   n   v   _   o   u   t   _   l   e   n   g   t   h   (   i   n   p   u   t   _   l   e   n   g   t   h   ,       k   e   r   n   e   l   _   s   i   z   e   ,       s   t   r   i   d   e   )   :   
                                                   #       1   D       c   o   n   v   o   l   u   t   i   o   n   a   l       l   a   y   e   r       o   u   t   p   u   t       l   e   n   g   t   h       f   o   r   m   u   l   a       t   a   k   e   n   
                                                   #       f   r   o   m       h   t   t   p   s   :   /   /   p   y   t   o   r   c   h   .   o   r   g   /   d   o   c   s   /   s   t   a   b   l   e   /   g   e   n   e   r   a   t   e   d   /   t   o   r   c   h   .   n   n   .   C   o   n   v   1   d   .   h   t   m   l   
                                                   r   e   t   u   r   n       t   o   r   c   h   .   d   i   v   (   i   n   p   u   t   _   l   e   n   g   t   h       -       k   e   r   n   e   l   _   s   i   z   e   ,       s   t   r   i   d   e   ,       r   o   u   n   d   i   n   g   _   m   o   d   e   =   "   f   l   o   o   r   "   )       +       1   
   
                                   f   o   r       k   e   r   n   e   l   _   s   i   z   e   ,       s   t   r   i   d   e       i   n       z   i   p   (   s   e   l   f   .   c   o   n   f   i   g   .   c   o   n   v   _   k   e   r   n   e   l   ,       s   e   l   f   .   c   o   n   f   i   g   .   c   o   n   v   _   s   t   r   i   d   e   )   :   
                                                   i   n   p   u   t   _   l   e   n   g   t   h   s       =       _   c   o   n   v   _   o   u   t   _   l   e   n   g   t   h   (   i   n   p   u   t   _   l   e   n   g   t   h   s   ,       k   e   r   n   e   l   _   s   i   z   e   ,       s   t   r   i   d   e   )   
   
                                   i   f       a   d   d   _   a   d   a   p   t   e   r   :   
                                                   f   o   r       _       i   n       r   a   n   g   e   (   s   e   l   f   .   c   o   n   f   i   g   .   n   u   m   _   a   d   a   p   t   e   r   _   l   a   y   e   r   s   )   :   
                                                                   i   n   p   u   t   _   l   e   n   g   t   h   s       =       _   c   o   n   v   _   o   u   t   _   l   e   n   g   t   h   (   i   n   p   u   t   _   l   e   n   g   t   h   s   ,       1   ,       s   e   l   f   .   c   o   n   f   i   g   .   a   d   a   p   t   e   r   _   s   t   r   i   d   e   )   
   
                                   r   e   t   u   r   n       i   n   p   u   t   _   l   e   n   g   t   h   s   
   
                   d   e   f       _   g   e   t   _   f   e   a   t   u   r   e   _   v   e   c   t   o   r   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   (   
                                   s   e   l   f   ,       f   e   a   t   u   r   e   _   v   e   c   t   o   r   _   l   e   n   g   t   h   :       i   n   t   ,       a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ,       a   d   d   _   a   d   a   p   t   e   r   =   N   o   n   e   
                   )   :   
                                   #       E   f   f   e   c   t   i   v   e   l   y       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   s   u   m   (   -   1   )   ,       b   u   t       n   o   t       i   n   p   l   a   c   e       t   o       b   e       a   b   l   e       t   o       r   u   n   
                                   #       o   n       i   n   f   e   r   e   n   c   e       m   o   d   e   .   
                                   n   o   n   _   p   a   d   d   e   d   _   l   e   n   g   t   h   s       =       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   c   u   m   s   u   m   (   d   i   m   =   -   1   )   [   :   ,       -   1   ]   
   
                                   o   u   t   p   u   t   _   l   e   n   g   t   h   s       =       s   e   l   f   .   _   g   e   t   _   f   e   a   t   _   e   x   t   r   a   c   t   _   o   u   t   p   u   t   _   l   e   n   g   t   h   s   (   n   o   n   _   p   a   d   d   e   d   _   l   e   n   g   t   h   s   ,       a   d   d   _   a   d   a   p   t   e   r   =   a   d   d   _   a   d   a   p   t   e   r   )   
                                   o   u   t   p   u   t   _   l   e   n   g   t   h   s       =       o   u   t   p   u   t   _   l   e   n   g   t   h   s   .   t   o   (   t   o   r   c   h   .   l   o   n   g   )   
   
                                   b   a   t   c   h   _   s   i   z   e       =       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   s   h   a   p   e   [   0   ]   
   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       t   o   r   c   h   .   z   e   r   o   s   (   
                                                   (   b   a   t   c   h   _   s   i   z   e   ,       f   e   a   t   u   r   e   _   v   e   c   t   o   r   _   l   e   n   g   t   h   )   ,       d   t   y   p   e   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   d   t   y   p   e   ,       d   e   v   i   c   e   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   d   e   v   i   c   e   
                                   )   
                                   #       t   h   e   s   e       t   w   o       o   p   e   r   a   t   i   o   n   s       m   a   k   e   s       s   u   r   e       t   h   a   t       a   l   l       v   a   l   u   e   s       b   e   f   o   r   e       t   h   e       o   u   t   p   u   t       l   e   n   g   t   h   s       i   d   x   s       a   r   e       a   t   t   e   n   d   e   d       t   o   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   [   (   t   o   r   c   h   .   a   r   a   n   g   e   (   a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   s   h   a   p   e   [   0   ]   ,       d   e   v   i   c   e   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   d   e   v   i   c   e   )   ,       o   u   t   p   u   t   _   l   e   n   g   t   h   s       -       1   )   ]       =       1   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   f   l   i   p   (   [   -   1   ]   )   .   c   u   m   s   u   m   (   -   1   )   .   f   l   i   p   (   [   -   1   ]   )   .   b   o   o   l   (   )   
                                   r   e   t   u   r   n       a   t   t   e   n   t   i   o   n   _   m   a   s   k   
   
   
   d   e   f       _   c   o   m   p   u   t   e   _   m   a   s   k   _   i   n   d   i   c   e   s   (   
                   s   h   a   p   e   :       t   u   p   l   e   [   i   n   t   ,       i   n   t   ]   ,   
                   m   a   s   k   _   p   r   o   b   :       f   l   o   a   t   ,   
                   m   a   s   k   _   l   e   n   g   t   h   :       i   n   t   ,   
                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                   m   i   n   _   m   a   s   k   s   :       i   n   t       =       0   ,   
   )       -   >       n   p   .   n   d   a   r   r   a   y   :   
                   "   "   "   
                   C   o   m   p   u   t   e   s       r   a   n   d   o   m       m   a   s   k       s   p   a   n   s       f   o   r       a       g   i   v   e   n       s   h   a   p   e   .       U   s   e   d       t   o       i   m   p   l   e   m   e   n   t       [   S   p   e   c   A   u   g   m   e   n   t   :       A       S   i   m   p   l   e       D   a   t   a       A   u   g   m   e   n   t   a   t   i   o   n       M   e   t   h   o   d       f   o   r   
                   A   S   R   ]   (   h   t   t   p   s   :   /   /   h   u   g   g   i   n   g   f   a   c   e   .   c   o   /   p   a   p   e   r   s   /   1   9   0   4   .   0   8   7   7   9   )   .       N   o   t   e       t   h   a   t       t   h   i   s       m   e   t   h   o   d       i   s       n   o   t       o   p   t   i   m   i   z   e   d       t   o       r   u   n       o   n       T   P   U       a   n   d       s   h   o   u   l   d       b   e       r   u   n       o   n   
                   C   P   U       a   s       p   a   r   t       o   f       t   h   e       p   r   e   p   r   o   c   e   s   s   i   n   g       d   u   r   i   n   g       t   r   a   i   n   i   n   g   .   
   
                   A   r   g   s   :   
                                   s   h   a   p   e   :       T   h   e       s   h   a   p   e       f   o   r       w   h   i   c   h       t   o       c   o   m   p   u   t   e       m   a   s   k   s   .       T   h   i   s       s   h   o   u   l   d       b   e       o   f       a       t   u   p   l   e       o   f       s   i   z   e       2       w   h   e   r   e   
                                                               t   h   e       f   i   r   s   t       e   l   e   m   e   n   t       i   s       t   h   e       b   a   t   c   h       s   i   z   e       a   n   d       t   h   e       s   e   c   o   n   d       e   l   e   m   e   n   t       i   s       t   h   e       l   e   n   g   t   h       o   f       t   h   e       a   x   i   s       t   o       s   p   a   n   .   
                                   m   a   s   k   _   p   r   o   b   :           T   h   e       p   e   r   c   e   n   t   a   g   e       o   f       t   h   e       w   h   o   l   e       a   x   i   s       (   b   e   t   w   e   e   n       0       a   n   d       1   )       w   h   i   c   h       w   i   l   l       b   e       m   a   s   k   e   d   .       T   h   e       n   u   m   b   e   r       o   f   
                                                                                   i   n   d   e   p   e   n   d   e   n   t   l   y       g   e   n   e   r   a   t   e   d       m   a   s   k       s   p   a   n   s       o   f       l   e   n   g   t   h       `   m   a   s   k   _   l   e   n   g   t   h   `       i   s       c   o   m   p   u   t   e   d       b   y   
                                                                                   `   m   a   s   k   _   p   r   o   b   *   s   h   a   p   e   [   1   ]   /   m   a   s   k   _   l   e   n   g   t   h   `   .       N   o   t   e       t   h   a   t       d   u   e       t   o       o   v   e   r   l   a   p   s   ,       `   m   a   s   k   _   p   r   o   b   `       i   s       a   n       u   p   p   e   r       b   o   u   n   d       a   n   d       t   h   e   
                                                                                   a   c   t   u   a   l       p   e   r   c   e   n   t   a   g   e       w   i   l   l       b   e       s   m   a   l   l   e   r   .   
                                   m   a   s   k   _   l   e   n   g   t   h   :       s   i   z   e       o   f       t   h   e       m   a   s   k   
                                   m   i   n   _   m   a   s   k   s   :       m   i   n   i   m   u   m       n   u   m   b   e   r       o   f       m   a   s   k   e   d       s   p   a   n   s   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       A       (   r   i   g   h   t   -   p   a   d   d   e   d   )       a   t   t   e   n   t   i   o   n       m   a   s   k       w   h   i   c   h       i   n   d   e   p   e   n   d   e   n   t   l   y       s   h   o   r   t   e   n   s       t   h   e       f   e   a   t   u   r   e       a   x   i   s       o   f   
                                                                                                   e   a   c   h       b   a   t   c   h       d   i   m   e   n   s   i   o   n   .   
                   "   "   "   
                   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       =       s   h   a   p   e   
   
                   i   f       m   a   s   k   _   l   e   n   g   t   h       <       1   :   
                                   r   a   i   s   e       V   a   l   u   e   E   r   r   o   r   (   "   `   m   a   s   k   _   l   e   n   g   t   h   `       h   a   s       t   o       b   e       b   i   g   g   e   r       t   h   a   n       0   .   "   )   
   
                   i   f       m   a   s   k   _   l   e   n   g   t   h       >       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   :   
                                   r   a   i   s   e       V   a   l   u   e   E   r   r   o   r   (   
                                                   f   "   `   m   a   s   k   _   l   e   n   g   t   h   `       h   a   s       t   o       b   e       s   m   a   l   l   e   r       t   h   a   n       `   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   `   ,       b   u   t       g   o   t       `   m   a   s   k   _   l   e   n   g   t   h   `   :       {   m   a   s   k   _   l   e   n   g   t   h   }   "   
                                                   f   "       a   n   d       `   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   `   :       {   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   }   `   "   
                                   )   
   
                   #       e   p   s   i   l   o   n       i   s       u   s   e   d       f   o   r       p   r   o   b   a   b   i   l   i   s   t   i   c       r   o   u   n   d   i   n   g   
                   e   p   s   i   l   o   n       =       n   p   .   r   a   n   d   o   m   .   r   a   n   d   (   1   )   .   i   t   e   m   (   )   
   
                   d   e   f       c   o   m   p   u   t   e   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   (   i   n   p   u   t   _   l   e   n   g   t   h   )   :   
                                   "   "   "   G   i   v   e   n       i   n   p   u   t       l   e   n   g   t   h   ,       c   o   m   p   u   t   e       h   o   w       m   a   n   y       s   p   a   n   s       s   h   o   u   l   d       b   e       m   a   s   k   e   d   "   "   "   
                                   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       =       i   n   t   (   m   a   s   k   _   p   r   o   b       *       i   n   p   u   t   _   l   e   n   g   t   h       /       m   a   s   k   _   l   e   n   g   t   h       +       e   p   s   i   l   o   n   )   
                                   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       =       m   a   x   (   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   ,       m   i   n   _   m   a   s   k   s   )   
   
                                   #       m   a   k   e       s   u   r   e       n   u   m       m   a   s   k   e   d       s   p   a   n       <   =       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   
                                   i   f       n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       *       m   a   s   k   _   l   e   n   g   t   h       >       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   :   
                                                   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       =       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       /   /       m   a   s   k   _   l   e   n   g   t   h   
   
                                   #       m   a   k   e       s   u   r   e       n   u   m   _   m   a   s   k   e   d       s   p   a   n       i   s       a   l   s   o       <   =       i   n   p   u   t   _   l   e   n   g   t   h       -       (   m   a   s   k   _   l   e   n   g   t   h       -       1   )   
                                   i   f       i   n   p   u   t   _   l   e   n   g   t   h       -       (   m   a   s   k   _   l   e   n   g   t   h       -       1   )       <       n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   :   
                                                   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       =       m   a   x   (   i   n   p   u   t   _   l   e   n   g   t   h       -       (   m   a   s   k   _   l   e   n   g   t   h       -       1   )   ,       0   )   
   
                                   r   e   t   u   r   n       n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   
   
                   #       c   o   m   p   u   t   e       n   u   m   b   e   r       o   f       m   a   s   k   e   d       s   p   a   n   s       i   n       b   a   t   c   h   
                   i   n   p   u   t   _   l   e   n   g   t   h   s       =       (   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   .   d   e   t   a   c   h   (   )   .   s   u   m   (   -   1   )   .   t   o   l   i   s   t   (   )   
                                   i   f       a   t   t   e   n   t   i   o   n   _   m   a   s   k       i   s       n   o   t       N   o   n   e   
                                   e   l   s   e       [   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       f   o   r       _       i   n       r   a   n   g   e   (   b   a   t   c   h   _   s   i   z   e   )   ]   
                   )   
   
                   #       S   p   e   c   A   u   g   m   e   n   t       m   a   s   k       t   o       f   i   l   l   
                   s   p   e   c   _   a   u   g   _   m   a   s   k       =       n   p   .   z   e   r   o   s   (   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   ,       d   t   y   p   e   =   b   o   o   l   )   
                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s       =       [   ]   
   
                   m   a   x   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       =       c   o   m   p   u   t   e   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   (   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   
   
                   i   f       m   a   x   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       =   =       0   :   
                                   r   e   t   u   r   n       s   p   e   c   _   a   u   g   _   m   a   s   k   
   
                   f   o   r       i   n   p   u   t   _   l   e   n   g   t   h       i   n       i   n   p   u   t   _   l   e   n   g   t   h   s   :   
                                   #       c   o   m   p   u   t   e       n   u   m       o   f       m   a   s   k   e   d       s   p   a   n   s       f   o   r       t   h   i   s       i   n   p   u   t   
                                   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       =       c   o   m   p   u   t   e   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   (   i   n   p   u   t   _   l   e   n   g   t   h   )   
   
                                   #       g   e   t       r   a   n   d   o   m       i   n   d   i   c   e   s       t   o       m   a   s   k   
                                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x       =       n   p   .   r   a   n   d   o   m   .   c   h   o   i   c   e   (   
                                                   n   p   .   a   r   a   n   g   e   (   i   n   p   u   t   _   l   e   n   g   t   h       -       (   m   a   s   k   _   l   e   n   g   t   h       -       1   )   )   ,       n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   ,       r   e   p   l   a   c   e   =   F   a   l   s   e   
                                   )   
   
                                   #       p   i   c   k       f   i   r   s   t       s   a   m   p   l   e   d       i   n   d   e   x       t   h   a   t       w   i   l   l       s   e   r   v   e       a   s       a       d   u   m   m   y       i   n   d   e   x       t   o       p   a   d       v   e   c   t   o   r   
                                   #       t   o       e   n   s   u   r   e       s   a   m   e       d   i   m   e   n   s   i   o   n       f   o   r       a   l   l       b   a   t   c   h   e   s       d   u   e       t   o       p   r   o   b   a   b   i   l   i   s   t   i   c       r   o   u   n   d   i   n   g   
                                   #       P   i   c   k   i   n   g       f   i   r   s   t       s   a   m   p   l   e       j   u   s   t       p   a   d   s       t   h   o   s   e       v   e   c   t   o   r   s       t   w   i   c   e   .   
                                   i   f       l   e   n   (   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   )       =   =       0   :   
                                                   #       t   h   i   s       c   a   s   e       c   a   n       o   n   l   y       h   a   p   p   e   n       i   f       `   i   n   p   u   t   _   l   e   n   g   t   h   `       i   s       s   t   r   i   c   t   l   y       s   m   a   l   l   e   r       t   h   e   n   
                                                   #       `   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   `       i   n       w   h   i   c   h       c   a   s   e       t   h   e       l   a   s   t       t   o   k   e   n       h   a   s       t   o       b   e       a       p   a   d   d   i   n   g   
                                                   #       t   o   k   e   n       w   h   i   c   h       w   e       c   a   n       u   s   e       a   s       a       d   u   m   m   y       m   a   s   k       i   d   
                                                   d   u   m   m   y   _   m   a   s   k   _   i   d   x       =       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       -       1   
                                   e   l   s   e   :   
                                                   d   u   m   m   y   _   m   a   s   k   _   i   d   x       =       s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   [   0   ]   
   
                                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x       =       n   p   .   c   o   n   c   a   t   e   n   a   t   e   (   
                                                   [   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   ,       n   p   .   o   n   e   s   (   m   a   x   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       -       n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   ,       d   t   y   p   e   =   n   p   .   i   n   t   3   2   )       *       d   u   m   m   y   _   m   a   s   k   _   i   d   x   ]   
                                   )   
                                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s   .   a   p   p   e   n   d   (   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   )   
   
                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s       =       n   p   .   a   r   r   a   y   (   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s   )   
   
                   #       e   x   p   a   n   d       m   a   s   k   e   d       i   n   d   i   c   e   s       t   o       m   a   s   k   e   d       s   p   a   n   s   
                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s       =       n   p   .   b   r   o   a   d   c   a   s   t   _   t   o   (   
                                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s   [   :   ,       :   ,       N   o   n   e   ]   ,       (   b   a   t   c   h   _   s   i   z   e   ,       m   a   x   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   ,       m   a   s   k   _   l   e   n   g   t   h   )   
                   )   
                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s       =       s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s   .   r   e   s   h   a   p   e   (   b   a   t   c   h   _   s   i   z   e   ,       m   a   x   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       *       m   a   s   k   _   l   e   n   g   t   h   )   
   
                   #       a   d   d       o   f   f   s   e   t       t   o       t   h   e       s   t   a   r   t   i   n   g       i   n   d   e   x   e   s       s   o       t   h   a   t       i   n   d   e   x   e   s       n   o   w       c   r   e   a   t   e       a       s   p   a   n   
                   o   f   f   s   e   t   s       =       n   p   .   a   r   a   n   g   e   (   m   a   s   k   _   l   e   n   g   t   h   )   [   N   o   n   e   ,       N   o   n   e   ,       :   ]   
                   o   f   f   s   e   t   s       =       n   p   .   b   r   o   a   d   c   a   s   t   _   t   o   (   o   f   f   s   e   t   s   ,       (   b   a   t   c   h   _   s   i   z   e   ,       m   a   x   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n   ,       m   a   s   k   _   l   e   n   g   t   h   )   )   .   r   e   s   h   a   p   e   (   
                                   b   a   t   c   h   _   s   i   z   e   ,       m   a   x   _   n   u   m   _   m   a   s   k   e   d   _   s   p   a   n       *       m   a   s   k   _   l   e   n   g   t   h   
                   )   
                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s       =       s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s       +       o   f   f   s   e   t   s   
   
                   #       e   n   s   u   r   e       t   h   a   t       w   e       c   a   n   n   o   t       h   a   v   e       i   n   d   i   c   e   s       l   a   r   g   e   r       t   h   a   n       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   
                   i   f       s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s   .   m   a   x   (   )       >       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       -       1   :   
                                   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s   [   s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s       >       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       -       1   ]       =       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       -       1   
   
                   #       s   c   a   t   t   e   r       i   n   d   i   c   e   s       t   o       m   a   s   k   
                   n   p   .   p   u   t   _   a   l   o   n   g   _   a   x   i   s   (   s   p   e   c   _   a   u   g   _   m   a   s   k   ,       s   p   e   c   _   a   u   g   _   m   a   s   k   _   i   d   x   s   ,       1   ,       -   1   )   
   
                   r   e   t   u   r   n       s   p   e   c   _   a   u   g   _   m   a   s   k   
   
   
   W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   B   a   s   e   M   o   d   e   l   O   u   t   p   u   t       =       W   a   v   2   V   e   c   2   B   a   s   e   M   o   d   e   l   O   u   t   p   u   t   
   
   
   @   a   u   t   o   _   d   o   c   s   t   r   i   n   g   
   c   l   a   s   s       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   M   o   d   e   l   (   W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   P   r   e   T   r   a   i   n   e   d   M   o   d   e   l   )   :   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   :       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   C   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   c   o   n   f   i   g       =       c   o   n   f   i   g   
                                   s   e   l   f   .   f   e   a   t   u   r   e   _   e   x   t   r   a   c   t   o   r       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   e   a   t   u   r   e   E   n   c   o   d   e   r   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   f   e   a   t   u   r   e   _   p   r   o   j   e   c   t   i   o   n       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   e   a   t   u   r   e   P   r   o   j   e   c   t   i   o   n   (   c   o   n   f   i   g   )   
   
                                   #       m   o   d   e   l       o   n   l   y       n   e   e   d   s       m   a   s   k   i   n   g       v   e   c   t   o   r       i   f       m   a   s   k       p   r   o   b       i   s       >       0   .   0   
                                   i   f       c   o   n   f   i   g   .   m   a   s   k   _   t   i   m   e   _   p   r   o   b       >       0   .   0       o   r       c   o   n   f   i   g   .   m   a   s   k   _   f   e   a   t   u   r   e   _   p   r   o   b       >       0   .   0   :   
                                                   s   e   l   f   .   m   a   s   k   e   d   _   s   p   e   c   _   e   m   b   e   d       =       n   n   .   P   a   r   a   m   e   t   e   r   (   t   o   r   c   h   .   T   e   n   s   o   r   (   c   o   n   f   i   g   .   h   i   d   d   e   n   _   s   i   z   e   )   .   u   n   i   f   o   r   m   _   (   )   )   
   
                                   s   e   l   f   .   e   n   c   o   d   e   r       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   E   n   c   o   d   e   r   (   c   o   n   f   i   g   )   
   
                                   s   e   l   f   .   a   d   a   p   t   e   r       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   A   d   a   p   t   e   r   (   c   o   n   f   i   g   )       i   f       c   o   n   f   i   g   .   a   d   d   _   a   d   a   p   t   e   r       e   l   s   e       N   o   n   e   
   
                                   #       I   n   i   t   i   a   l   i   z   e       w   e   i   g   h   t   s       a   n   d       a   p   p   l   y       f   i   n   a   l       p   r   o   c   e   s   s   i   n   g   
                                   s   e   l   f   .   p   o   s   t   _   i   n   i   t   (   )   
   
                   d   e   f       f   r   e   e   z   e   _   f   e   a   t   u   r   e   _   e   n   c   o   d   e   r   (   s   e   l   f   )   :   
                                   "   "   "   
                                   C   a   l   l   i   n   g       t   h   i   s       f   u   n   c   t   i   o   n       w   i   l   l       d   i   s   a   b   l   e       t   h   e       g   r   a   d   i   e   n   t       c   o   m   p   u   t   a   t   i   o   n       f   o   r       t   h   e       f   e   a   t   u   r   e       e   n   c   o   d   e   r       s   o       t   h   a   t       i   t   s       p   a   r   a   m   e   t   e   r       w   i   l   l   
                                   n   o   t       b   e       u   p   d   a   t   e   d       d   u   r   i   n   g       t   r   a   i   n   i   n   g   .   
                                   "   "   "   
                                   s   e   l   f   .   f   e   a   t   u   r   e   _   e   x   t   r   a   c   t   o   r   .   _   f   r   e   e   z   e   _   p   a   r   a   m   e   t   e   r   s   (   )   
   
                   d   e   f       _   m   a   s   k   _   h   i   d   d   e   n   _   s   t   a   t   e   s   (   
                                   s   e   l   f   ,   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s   :       t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   ,   
                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   L   o   n   g   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                   )   :   
                                   "   "   "   
                                   M   a   s   k   s       e   x   t   r   a   c   t   e   d       f   e   a   t   u   r   e   s       a   l   o   n   g       t   i   m   e       a   x   i   s       a   n   d   /   o   r       a   l   o   n   g       f   e   a   t   u   r   e       a   x   i   s       a   c   c   o   r   d   i   n   g       t   o   
                                   [   S   p   e   c   A   u   g   m   e   n   t   ]   (   h   t   t   p   s   :   /   /   h   u   g   g   i   n   g   f   a   c   e   .   c   o   /   p   a   p   e   r   s   /   1   9   0   4   .   0   8   7   7   9   )   .   
                                   "   "   "   
   
                                   #       `   c   o   n   f   i   g   .   a   p   p   l   y   _   s   p   e   c   _   a   u   g   m   e   n   t   `       c   a   n       s   e   t       m   a   s   k   i   n   g       t   o       F   a   l   s   e   
                                   i   f       n   o   t       g   e   t   a   t   t   r   (   s   e   l   f   .   c   o   n   f   i   g   ,       "   a   p   p   l   y   _   s   p   e   c   _   a   u   g   m   e   n   t   "   ,       T   r   u   e   )   :   
                                                   r   e   t   u   r   n       h   i   d   d   e   n   _   s   t   a   t   e   s   
   
                                   #       g   e   n   e   r   a   t   e       i   n   d   i   c   e   s       &       a   p   p   l   y       S   p   e   c   A   u   g   m   e   n   t       a   l   o   n   g       t   i   m   e       a   x   i   s   
                                   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       h   i   d   d   e   n   _   s   i   z   e       =       h   i   d   d   e   n   _   s   t   a   t   e   s   .   s   i   z   e   (   )   
   
                                   i   f       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       i   s       n   o   t       N   o   n   e   :   
                                                   #       a   p   p   l   y       S   p   e   c   A   u   g   m   e   n   t       a   l   o   n   g       t   i   m   e       a   x   i   s       w   i   t   h       g   i   v   e   n       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   [   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ]       =       s   e   l   f   .   m   a   s   k   e   d   _   s   p   e   c   _   e   m   b   e   d   .   t   o   (   h   i   d   d   e   n   _   s   t   a   t   e   s   .   d   t   y   p   e   )   
                                   e   l   i   f       s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   t   i   m   e   _   p   r   o   b       >       0       a   n   d       s   e   l   f   .   t   r   a   i   n   i   n   g   :   
                                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       =       _   c   o   m   p   u   t   e   _   m   a   s   k   _   i   n   d   i   c   e   s   (   
                                                                   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   ,   
                                                                   m   a   s   k   _   p   r   o   b   =   s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   t   i   m   e   _   p   r   o   b   ,   
                                                                   m   a   s   k   _   l   e   n   g   t   h   =   s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   t   i   m   e   _   l   e   n   g   t   h   ,   
                                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   
                                                                   m   i   n   _   m   a   s   k   s   =   s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   t   i   m   e   _   m   i   n   _   m   a   s   k   s   ,   
                                                   )   
                                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       =       t   o   r   c   h   .   t   e   n   s   o   r   (   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ,       d   e   v   i   c   e   =   h   i   d   d   e   n   _   s   t   a   t   e   s   .   d   e   v   i   c   e   ,       d   t   y   p   e   =   t   o   r   c   h   .   b   o   o   l   )   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   [   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ]       =       s   e   l   f   .   m   a   s   k   e   d   _   s   p   e   c   _   e   m   b   e   d   .   t   o   (   h   i   d   d   e   n   _   s   t   a   t   e   s   .   d   t   y   p   e   )   
   
                                   i   f       s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   f   e   a   t   u   r   e   _   p   r   o   b       >       0       a   n   d       s   e   l   f   .   t   r   a   i   n   i   n   g   :   
                                                   #       g   e   n   e   r   a   t   e       i   n   d   i   c   e   s       &       a   p   p   l   y       S   p   e   c   A   u   g   m   e   n   t       a   l   o   n   g       f   e   a   t   u   r   e       a   x   i   s   
                                                   m   a   s   k   _   f   e   a   t   u   r   e   _   i   n   d   i   c   e   s       =       _   c   o   m   p   u   t   e   _   m   a   s   k   _   i   n   d   i   c   e   s   (   
                                                                   (   b   a   t   c   h   _   s   i   z   e   ,       h   i   d   d   e   n   _   s   i   z   e   )   ,   
                                                                   m   a   s   k   _   p   r   o   b   =   s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   f   e   a   t   u   r   e   _   p   r   o   b   ,   
                                                                   m   a   s   k   _   l   e   n   g   t   h   =   s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   f   e   a   t   u   r   e   _   l   e   n   g   t   h   ,   
                                                                   m   i   n   _   m   a   s   k   s   =   s   e   l   f   .   c   o   n   f   i   g   .   m   a   s   k   _   f   e   a   t   u   r   e   _   m   i   n   _   m   a   s   k   s   ,   
                                                   )   
                                                   m   a   s   k   _   f   e   a   t   u   r   e   _   i   n   d   i   c   e   s       =       t   o   r   c   h   .   t   e   n   s   o   r   (   m   a   s   k   _   f   e   a   t   u   r   e   _   i   n   d   i   c   e   s   ,       d   e   v   i   c   e   =   h   i   d   d   e   n   _   s   t   a   t   e   s   .   d   e   v   i   c   e   ,       d   t   y   p   e   =   t   o   r   c   h   .   b   o   o   l   )   
                                                   m   a   s   k   _   f   e   a   t   u   r   e   _   i   n   d   i   c   e   s       =       m   a   s   k   _   f   e   a   t   u   r   e   _   i   n   d   i   c   e   s   [   :   ,       N   o   n   e   ]   .   e   x   p   a   n   d   (   -   1   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       -   1   )   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   [   m   a   s   k   _   f   e   a   t   u   r   e   _   i   n   d   i   c   e   s   ]       =       0   
   
                                   r   e   t   u   r   n       h   i   d   d   e   n   _   s   t   a   t   e   s   
   
                   @   a   u   t   o   _   d   o   c   s   t   r   i   n   g   
                   d   e   f       f   o   r   w   a   r   d   (   
                                   s   e   l   f   ,   
                                   i   n   p   u   t   _   v   a   l   u   e   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   T   e   n   s   o   r   ]   ,   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                                   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                                   r   e   t   u   r   n   _   d   i   c   t   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                   )       -   >       U   n   i   o   n   [   t   u   p   l   e   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   B   a   s   e   M   o   d   e   l   O   u   t   p   u   t   ]   :   
                                   r   "   "   "   
                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       (   `   t   o   r   c   h   .   B   o   o   l   T   e   n   s   o   r   `       o   f       s   h   a   p   e       `   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   `   ,       *   o   p   t   i   o   n   a   l   *   )   :   
                                                   I   n   d   i   c   e   s       t   o       m   a   s   k       e   x   t   r   a   c   t   e   d       f   e   a   t   u   r   e   s       f   o   r       c   o   n   t   r   a   s   t   i   v   e       l   o   s   s   .       W   h   e   n       i   n       t   r   a   i   n   i   n   g       m   o   d   e   ,       m   o   d   e   l       l   e   a   r   n   s       t   o       p   r   e   d   i   c   t   
                                                   m   a   s   k   e   d       e   x   t   r   a   c   t   e   d       f   e   a   t   u   r   e   s       i   n       *   c   o   n   f   i   g   .   p   r   o   j   _   c   o   d   e   v   e   c   t   o   r   _   d   i   m   *       s   p   a   c   e   .   
                                   "   "   "   
                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s       =       o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s       i   f       o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s       i   s       n   o   t       N   o   n   e       e   l   s   e       s   e   l   f   .   c   o   n   f   i   g   .   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   
                                   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s       =       (   
                                                   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s       i   f       o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s       i   s       n   o   t       N   o   n   e       e   l   s   e       s   e   l   f   .   c   o   n   f   i   g   .   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   
                                   )   
                                   r   e   t   u   r   n   _   d   i   c   t       =       r   e   t   u   r   n   _   d   i   c   t       i   f       r   e   t   u   r   n   _   d   i   c   t       i   s       n   o   t       N   o   n   e       e   l   s   e       s   e   l   f   .   c   o   n   f   i   g   .   u   s   e   _   r   e   t   u   r   n   _   d   i   c   t   
   
                                   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s       =       s   e   l   f   .   f   e   a   t   u   r   e   _   e   x   t   r   a   c   t   o   r   (   i   n   p   u   t   _   v   a   l   u   e   s   )   
                                   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s       =       e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s   .   t   r   a   n   s   p   o   s   e   (   1   ,       2   )   
   
                                   i   f       a   t   t   e   n   t   i   o   n   _   m   a   s   k       i   s       n   o   t       N   o   n   e   :   
                                                   #       c   o   m   p   u   t   e       r   e   d   u   c   e   d       a   t   t   e   n   t   i   o   n   _   m   a   s   k       c   o   r   r   e   s   p   o   n   d   i   n   g       t   o       f   e   a   t   u   r   e       v   e   c   t   o   r   s   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       s   e   l   f   .   _   g   e   t   _   f   e   a   t   u   r   e   _   v   e   c   t   o   r   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   (   
                                                                   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s   .   s   h   a   p   e   [   1   ]   ,       a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,       a   d   d   _   a   d   a   p   t   e   r   =   F   a   l   s   e   
                                                   )   
   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s   ,       e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s       =       s   e   l   f   .   f   e   a   t   u   r   e   _   p   r   o   j   e   c   t   i   o   n   (   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s   )   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   _   m   a   s   k   _   h   i   d   d   e   n   _   s   t   a   t   e   s   (   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   ,       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   =   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ,       a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   
                                   )   
   
                                   e   n   c   o   d   e   r   _   o   u   t   p   u   t   s       =       s   e   l   f   .   e   n   c   o   d   e   r   (   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   
                                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   =   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   ,   
                                                   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   =   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   r   e   t   u   r   n   _   d   i   c   t   =   r   e   t   u   r   n   _   d   i   c   t   ,   
                                   )   
   
                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       e   n   c   o   d   e   r   _   o   u   t   p   u   t   s   [   0   ]   
   
                                   i   f       s   e   l   f   .   a   d   a   p   t   e   r       i   s       n   o   t       N   o   n   e   :   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s       =       s   e   l   f   .   a   d   a   p   t   e   r   (   h   i   d   d   e   n   _   s   t   a   t   e   s   )   
   
                                   i   f       n   o   t       r   e   t   u   r   n   _   d   i   c   t   :   
                                                   r   e   t   u   r   n       (   h   i   d   d   e   n   _   s   t   a   t   e   s   ,       e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s   )       +       e   n   c   o   d   e   r   _   o   u   t   p   u   t   s   [   1   :   ]   
   
                                   r   e   t   u   r   n       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   B   a   s   e   M   o   d   e   l   O   u   t   p   u   t   (   
                                                   l   a   s   t   _   h   i   d   d   e   n   _   s   t   a   t   e   =   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s   =   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s   ,   
                                                   h   i   d   d   e   n   _   s   t   a   t   e   s   =   e   n   c   o   d   e   r   _   o   u   t   p   u   t   s   .   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   a   t   t   e   n   t   i   o   n   s   =   e   n   c   o   d   e   r   _   o   u   t   p   u   t   s   .   a   t   t   e   n   t   i   o   n   s   ,   
                                   )   
   
   
   @   a   u   t   o   _   d   o   c   s   t   r   i   n   g   (   
                   c   u   s   t   o   m   _   i   n   t   r   o   =   "   "   "   
                   W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r       M   o   d   e   l       w   i   t   h       a       q   u   a   n   t   i   z   e   r       a   n   d       `   V   Q   `       h   e   a   d       o   n       t   o   p   .   
                   "   "   "   
   )   
   c   l   a   s   s       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   o   r   P   r   e   T   r   a   i   n   i   n   g   (   W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   P   r   e   T   r   a   i   n   e   d   M   o   d   e   l   )   :   
                   d   e   f       _   _   i   n   i   t   _   _   (   s   e   l   f   ,       c   o   n   f   i   g   :       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   C   o   n   f   i   g   )   :   
                                   s   u   p   e   r   (   )   .   _   _   i   n   i   t   _   _   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   M   o   d   e   l   (   c   o   n   f   i   g   )   
                                   s   e   l   f   .   d   r   o   p   o   u   t   _   f   e   a   t   u   r   e   s       =       n   n   .   D   r   o   p   o   u   t   (   c   o   n   f   i   g   .   f   e   a   t   _   q   u   a   n   t   i   z   e   r   _   d   r   o   p   o   u   t   )   
   
                                   s   e   l   f   .   q   u   a   n   t   i   z   e   r       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   G   u   m   b   e   l   V   e   c   t   o   r   Q   u   a   n   t   i   z   e   r   (   c   o   n   f   i   g   )   
   
                                   s   e   l   f   .   p   r   o   j   e   c   t   _   h   i   d       =       n   n   .   L   i   n   e   a   r   (   c   o   n   f   i   g   .   h   i   d   d   e   n   _   s   i   z   e   ,       c   o   n   f   i   g   .   p   r   o   j   _   c   o   d   e   v   e   c   t   o   r   _   d   i   m   )   
                                   s   e   l   f   .   p   r   o   j   e   c   t   _   q       =       n   n   .   L   i   n   e   a   r   (   c   o   n   f   i   g   .   c   o   d   e   v   e   c   t   o   r   _   d   i   m   ,       c   o   n   f   i   g   .   p   r   o   j   _   c   o   d   e   v   e   c   t   o   r   _   d   i   m   )   
   
                                   #       I   n   i   t   i   a   l   i   z   e       w   e   i   g   h   t   s       a   n   d       a   p   p   l   y       f   i   n   a   l       p   r   o   c   e   s   s   i   n   g   
                                   s   e   l   f   .   p   o   s   t   _   i   n   i   t   (   )   
   
                   d   e   f       s   e   t   _   g   u   m   b   e   l   _   t   e   m   p   e   r   a   t   u   r   e   (   s   e   l   f   ,       t   e   m   p   e   r   a   t   u   r   e   :       i   n   t   )   :   
                                   "   "   "   
                                   S   e   t       t   h   e       G   u   m   b   e   l       s   o   f   t   m   a   x       t   e   m   p   e   r   a   t   u   r   e       t   o       a       g   i   v   e   n       v   a   l   u   e   .       O   n   l   y       n   e   c   e   s   s   a   r   y       f   o   r       t   r   a   i   n   i   n   g   
                                   "   "   "   
                                   s   e   l   f   .   q   u   a   n   t   i   z   e   r   .   t   e   m   p   e   r   a   t   u   r   e       =       t   e   m   p   e   r   a   t   u   r   e   
   
                   d   e   f       f   r   e   e   z   e   _   f   e   a   t   u   r   e   _   e   n   c   o   d   e   r   (   s   e   l   f   )   :   
                                   "   "   "   
                                   C   a   l   l   i   n   g       t   h   i   s       f   u   n   c   t   i   o   n       w   i   l   l       d   i   s   a   b   l   e       t   h   e       g   r   a   d   i   e   n   t       c   o   m   p   u   t   a   t   i   o   n       f   o   r       t   h   e       f   e   a   t   u   r   e       e   n   c   o   d   e   r       s   o       t   h   a   t       i   t   s       p   a   r   a   m   e   t   e   r       w   i   l   l   
                                   n   o   t       b   e       u   p   d   a   t   e   d       d   u   r   i   n   g       t   r   a   i   n   i   n   g   .   
                                   "   "   "   
                                   s   e   l   f   .   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r   .   f   e   a   t   u   r   e   _   e   x   t   r   a   c   t   o   r   .   _   f   r   e   e   z   e   _   p   a   r   a   m   e   t   e   r   s   (   )   
   
                   @   s   t   a   t   i   c   m   e   t   h   o   d   
                   d   e   f       c   o   m   p   u   t   e   _   c   o   n   t   r   a   s   t   i   v   e   _   l   o   g   i   t   s   (   
                                   t   a   r   g   e   t   _   f   e   a   t   u   r   e   s   :       t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   ,   
                                   n   e   g   a   t   i   v   e   _   f   e   a   t   u   r   e   s   :       t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   ,   
                                   p   r   e   d   i   c   t   e   d   _   f   e   a   t   u   r   e   s   :       t   o   r   c   h   .   F   l   o   a   t   T   e   n   s   o   r   ,   
                                   t   e   m   p   e   r   a   t   u   r   e   :       i   n   t       =       0   .   1   ,   
                   )   :   
                                   "   "   "   
                                   C   o   m   p   u   t   e       l   o   g   i   t   s       f   o   r       c   o   n   t   r   a   s   t   i   v   e       l   o   s   s       b   a   s   e   d       u   s   i   n   g       c   o   s   i   n   e       s   i   m   i   l   a   r   i   t   y       a   s       t   h   e       d   i   s   t   a   n   c   e       m   e   a   s   u   r   e       b   e   t   w   e   e   n   
                                   `   [   p   o   s   i   t   i   v   e   _   f   e   a   t   u   r   e   ,       n   e   g   a   t   i   v   e   _   f   e   a   t   u   r   e   s   ]   `       a   n   d       `   [   p   r   e   d   i   c   t   e   d   _   f   e   a   t   u   r   e   s   ]   `   .       A   d   d   i   t   i   o   n   a   l   l   y   ,       t   e   m   p   e   r   a   t   u   r   e       c   a   n       b   e       a   p   p   l   i   e   d   .   
                                   "   "   "   
                                   t   a   r   g   e   t   _   f   e   a   t   u   r   e   s       =       t   o   r   c   h   .   c   a   t   (   [   t   a   r   g   e   t   _   f   e   a   t   u   r   e   s   ,       n   e   g   a   t   i   v   e   _   f   e   a   t   u   r   e   s   ]   ,       d   i   m   =   0   )   
   
                                   l   o   g   i   t   s       =       t   o   r   c   h   .   c   o   s   i   n   e   _   s   i   m   i   l   a   r   i   t   y   (   p   r   e   d   i   c   t   e   d   _   f   e   a   t   u   r   e   s   .   f   l   o   a   t   (   )   ,       t   a   r   g   e   t   _   f   e   a   t   u   r   e   s   .   f   l   o   a   t   (   )   ,       d   i   m   =   -   1   )   .   t   y   p   e   _   a   s   (   
                                                   t   a   r   g   e   t   _   f   e   a   t   u   r   e   s   
                                   )   
   
                                   #       a   p   p   l   y       t   e   m   p   e   r   a   t   u   r   e   
                                   l   o   g   i   t   s       =       l   o   g   i   t   s       /       t   e   m   p   e   r   a   t   u   r   e   
                                   r   e   t   u   r   n       l   o   g   i   t   s   
   
                   @   a   u   t   o   _   d   o   c   s   t   r   i   n   g   
                   d   e   f       f   o   r   w   a   r   d   (   
                                   s   e   l   f   ,   
                                   i   n   p   u   t   _   v   a   l   u   e   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   T   e   n   s   o   r   ]   ,   
                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   B   o   o   l   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   s   a   m   p   l   e   d   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s   :       O   p   t   i   o   n   a   l   [   t   o   r   c   h   .   B   o   o   l   T   e   n   s   o   r   ]       =       N   o   n   e   ,   
                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                                   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                                   r   e   t   u   r   n   _   d   i   c   t   :       O   p   t   i   o   n   a   l   [   b   o   o   l   ]       =       N   o   n   e   ,   
                   )       -   >       U   n   i   o   n   [   t   u   p   l   e   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   o   r   P   r   e   T   r   a   i   n   i   n   g   O   u   t   p   u   t   ]   :   
                                   r   "   "   "   
                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       (   `   t   o   r   c   h   .   B   o   o   l   T   e   n   s   o   r   `       o   f       s   h   a   p   e       `   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   `   ,       *   o   p   t   i   o   n   a   l   *   )   :   
                                                   I   n   d   i   c   e   s       t   o       m   a   s   k       e   x   t   r   a   c   t   e   d       f   e   a   t   u   r   e   s       f   o   r       c   o   n   t   r   a   s   t   i   v   e       l   o   s   s   .       W   h   e   n       i   n       t   r   a   i   n   i   n   g       m   o   d   e   ,       m   o   d   e   l       l   e   a   r   n   s       t   o       p   r   e   d   i   c   t   
                                                   m   a   s   k   e   d       e   x   t   r   a   c   t   e   d       f   e   a   t   u   r   e   s       i   n       *   c   o   n   f   i   g   .   p   r   o   j   _   c   o   d   e   v   e   c   t   o   r   _   d   i   m   *       s   p   a   c   e   .   
                                   s   a   m   p   l   e   d   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s       (   `   t   o   r   c   h   .   B   o   o   l   T   e   n   s   o   r   `       o   f       s   h   a   p   e       `   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   ,       n   u   m   _   n   e   g   a   t   i   v   e   s   )   `   ,       *   o   p   t   i   o   n   a   l   *   )   :   
                                                   I   n   d   i   c   e   s       i   n   d   i   c   a   t   i   n   g       w   h   i   c   h       q   u   a   n   t   i   z   e   d       t   a   r   g   e   t       v   e   c   t   o   r   s       a   r   e       u   s   e   d       a   s       n   e   g   a   t   i   v   e       s   a   m   p   l   e   d       v   e   c   t   o   r   s       i   n       c   o   n   t   r   a   s   t   i   v   e       l   o   s   s   .   
                                                   R   e   q   u   i   r   e   d       i   n   p   u   t       f   o   r       p   r   e   -   t   r   a   i   n   i   n   g   .   
   
                                   E   x   a   m   p   l   e   :   
   
                                   `   `   `   p   y   t   h   o   n   
                                   >   >   >       i   m   p   o   r   t       t   o   r   c   h   
                                   >   >   >       f   r   o   m       t   r   a   n   s   f   o   r   m   e   r   s       i   m   p   o   r   t       A   u   t   o   F   e   a   t   u   r   e   E   x   t   r   a   c   t   o   r   ,       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   o   r   P   r   e   T   r   a   i   n   i   n   g   
                                   >   >   >       f   r   o   m       t   r   a   n   s   f   o   r   m   e   r   s   .   m   o   d   e   l   s   .   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r   .   m   o   d   e   l   i   n   g   _   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r       i   m   p   o   r   t       _   c   o   m   p   u   t   e   _   m   a   s   k   _   i   n   d   i   c   e   s   ,       _   s   a   m   p   l   e   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s   
                                   >   >   >       f   r   o   m       d   a   t   a   s   e   t   s       i   m   p   o   r   t       l   o   a   d   _   d   a   t   a   s   e   t   
   
                                   >   >   >       f   e   a   t   u   r   e   _   e   x   t   r   a   c   t   o   r       =       A   u   t   o   F   e   a   t   u   r   e   E   x   t   r   a   c   t   o   r   .   f   r   o   m   _   p   r   e   t   r   a   i   n   e   d   (   "   f   a   c   e   b   o   o   k   /   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r   -   b   a   s   e   "   )   
                                   >   >   >       m   o   d   e   l       =       W   a   v   2   V   e   c   2   C   o   n   f   o   r   m   e   r   F   o   r   P   r   e   T   r   a   i   n   i   n   g   .   f   r   o   m   _   p   r   e   t   r   a   i   n   e   d   (   "   f   a   c   e   b   o   o   k   /   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r   -   b   a   s   e   "   )   
   
                                   >   >   >       d   s       =       l   o   a   d   _   d   a   t   a   s   e   t   (   "   h   f   -   i   n   t   e   r   n   a   l   -   t   e   s   t   i   n   g   /   l   i   b   r   i   s   p   e   e   c   h   _   a   s   r   _   d   u   m   m   y   "   ,       "   c   l   e   a   n   "   ,       s   p   l   i   t   =   "   v   a   l   i   d   a   t   i   o   n   "   )   
                                   >   >   >       i   n   p   u   t   _   v   a   l   u   e   s       =       f   e   a   t   u   r   e   _   e   x   t   r   a   c   t   o   r   (   d   s   [   0   ]   [   "   a   u   d   i   o   "   ]   [   "   a   r   r   a   y   "   ]   ,       r   e   t   u   r   n   _   t   e   n   s   o   r   s   =   "   p   t   "   )   .   i   n   p   u   t   _   v   a   l   u   e   s           #       B   a   t   c   h       s   i   z   e       1   
   
                                   >   >   >       #       c   o   m   p   u   t   e       m   a   s   k   e   d       i   n   d   i   c   e   s   
                                   >   >   >       b   a   t   c   h   _   s   i   z   e   ,       r   a   w   _   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       =       i   n   p   u   t   _   v   a   l   u   e   s   .   s   h   a   p   e   
                                   >   >   >       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h       =       m   o   d   e   l   .   _   g   e   t   _   f   e   a   t   _   e   x   t   r   a   c   t   _   o   u   t   p   u   t   _   l   e   n   g   t   h   s   (   r   a   w   _   s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   .   i   t   e   m   (   )   
                                   >   >   >       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       =       _   c   o   m   p   u   t   e   _   m   a   s   k   _   i   n   d   i   c   e   s   (   
                                   .   .   .                       s   h   a   p   e   =   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   ,       m   a   s   k   _   p   r   o   b   =   0   .   2   ,       m   a   s   k   _   l   e   n   g   t   h   =   2   
                                   .   .   .       )   
                                   >   >   >       s   a   m   p   l   e   d   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s       =       _   s   a   m   p   l   e   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s   (   
                                   .   .   .                       f   e   a   t   u   r   e   s   _   s   h   a   p   e   =   (   b   a   t   c   h   _   s   i   z   e   ,       s   e   q   u   e   n   c   e   _   l   e   n   g   t   h   )   ,   
                                   .   .   .                       n   u   m   _   n   e   g   a   t   i   v   e   s   =   m   o   d   e   l   .   c   o   n   f   i   g   .   n   u   m   _   n   e   g   a   t   i   v   e   s   ,   
                                   .   .   .                       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   =   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ,   
                                   .   .   .       )   
                                   >   >   >       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       =       t   o   r   c   h   .   t   e   n   s   o   r   (   d   a   t   a   =   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ,       d   e   v   i   c   e   =   i   n   p   u   t   _   v   a   l   u   e   s   .   d   e   v   i   c   e   ,       d   t   y   p   e   =   t   o   r   c   h   .   l   o   n   g   )   
                                   >   >   >       s   a   m   p   l   e   d   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s       =       t   o   r   c   h   .   t   e   n   s   o   r   (   
                                   .   .   .                       d   a   t   a   =   s   a   m   p   l   e   d   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s   ,       d   e   v   i   c   e   =   i   n   p   u   t   _   v   a   l   u   e   s   .   d   e   v   i   c   e   ,       d   t   y   p   e   =   t   o   r   c   h   .   l   o   n   g   
                                   .   .   .       )   
   
                                   >   >   >       w   i   t   h       t   o   r   c   h   .   n   o   _   g   r   a   d   (   )   :   
                                   .   .   .                       o   u   t   p   u   t   s       =       m   o   d   e   l   (   i   n   p   u   t   _   v   a   l   u   e   s   ,       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   =   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   )   
   
                                   >   >   >       #       c   o   m   p   u   t   e       c   o   s   i   n   e       s   i   m   i   l   a   r   i   t   y       b   e   t   w   e   e   n       p   r   e   d   i   c   t   e   d       (   =   p   r   o   j   e   c   t   e   d   _   s   t   a   t   e   s   )       a   n   d       t   a   r   g   e   t       (   =   p   r   o   j   e   c   t   e   d   _   q   u   a   n   t   i   z   e   d   _   s   t   a   t   e   s   )   
                                   >   >   >       c   o   s   i   n   e   _   s   i   m       =       t   o   r   c   h   .   c   o   s   i   n   e   _   s   i   m   i   l   a   r   i   t   y   (   o   u   t   p   u   t   s   .   p   r   o   j   e   c   t   e   d   _   s   t   a   t   e   s   ,       o   u   t   p   u   t   s   .   p   r   o   j   e   c   t   e   d   _   q   u   a   n   t   i   z   e   d   _   s   t   a   t   e   s   ,       d   i   m   =   -   1   )   
   
                                   >   >   >       #       s   h   o   w       t   h   a   t       c   o   s   i   n   e       s   i   m   i   l   a   r   i   t   y       i   s       m   u   c   h       h   i   g   h   e   r       t   h   a   n       r   a   n   d   o   m   
                                   >   >   >       c   o   s   i   n   e   _   s   i   m   [   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   .   t   o   (   t   o   r   c   h   .   b   o   o   l   )   ]   .   m   e   a   n   (   )       >       0   .   5   
                                   t   e   n   s   o   r   (   T   r   u   e   )   
   
                                   >   >   >       #       f   o   r       c   o   n   t   r   a   s   t   i   v   e       l   o   s   s       t   r   a   i   n   i   n   g       m   o   d   e   l       s   h   o   u   l   d       b   e       p   u   t       i   n   t   o       t   r   a   i   n       m   o   d   e   
                                   >   >   >       m   o   d   e   l       =       m   o   d   e   l   .   t   r   a   i   n   (   )   
                                   >   >   >       l   o   s   s       =       m   o   d   e   l   (   
                                   .   .   .                       i   n   p   u   t   _   v   a   l   u   e   s   ,       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   =   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ,       s   a   m   p   l   e   d   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s   =   s   a   m   p   l   e   d   _   n   e   g   a   t   i   v   e   _   i   n   d   i   c   e   s   
                                   .   .   .       )   .   l   o   s   s   
                                   `   `   `   "   "   "   
   
                                   r   e   t   u   r   n   _   d   i   c   t       =       r   e   t   u   r   n   _   d   i   c   t       i   f       r   e   t   u   r   n   _   d   i   c   t       i   s       n   o   t       N   o   n   e       e   l   s   e       s   e   l   f   .   c   o   n   f   i   g   .   u   s   e   _   r   e   t   u   r   n   _   d   i   c   t   
   
                                   i   f       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       i   s       n   o   t       N   o   n   e   :   
                                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s       =       m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   .   t   o   (   t   o   r   c   h   .   b   o   o   l   )   
   
                                   o   u   t   p   u   t   s       =       s   e   l   f   .   w   a   v   2   v   e   c   2   _   c   o   n   f   o   r   m   e   r   (   
                                                   i   n   p   u   t   _   v   a   l   u   e   s   ,   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k   =   a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   
                                                   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   =   o   u   t   p   u   t   _   a   t   t   e   n   t   i   o   n   s   ,   
                                                   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   =   o   u   t   p   u   t   _   h   i   d   d   e   n   _   s   t   a   t   e   s   ,   
                                                   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   =   m   a   s   k   _   t   i   m   e   _   i   n   d   i   c   e   s   ,   
                                                   r   e   t   u   r   n   _   d   i   c   t   =   r   e   t   u   r   n   _   d   i   c   t   ,   
                                   )   
   
                                   #       1   .       p   r   o   j   e   c   t       a   l   l       t   r   a   n   s   f   o   r   m   e   d       f   e   a   t   u   r   e   s       (   i   n   c   l   u   d   i   n   g       m   a   s   k   e   d   )       t   o       f   i   n   a   l       v   q       d   i   m   
                                   t   r   a   n   s   f   o   r   m   e   r   _   f   e   a   t   u   r   e   s       =       s   e   l   f   .   p   r   o   j   e   c   t   _   h   i   d   (   o   u   t   p   u   t   s   [   0   ]   )   
   
                                   #       2   .       q   u   a   n   t   i   z   e       a   l   l       (   u   n   m   a   s   k   e   d   )       e   x   t   r   a   c   t   e   d       f   e   a   t   u   r   e   s       a   n   d       p   r   o   j   e   c   t       t   o       f   i   n   a   l       v   q       d   i   m   
                                   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s       =       s   e   l   f   .   d   r   o   p   o   u   t   _   f   e   a   t   u   r   e   s   (   o   u   t   p   u   t   s   [   1   ]   )   
   
                                   i   f       a   t   t   e   n   t   i   o   n   _   m   a   s   k       i   s       n   o   t       N   o   n   e   :   
                                                   #       c   o   m   p   u   t   e       r   e   d   u   c   e   d       a   t   t   e   n   t   i   o   n   _   m   a   s   k       c   o   r   r   e   s   p   o   n   d   i   n   g       t   o       f   e   a   t   u   r   e       v   e   c   t   o   r   s   
                                                   a   t   t   e   n   t   i   o   n   _   m   a   s   k       =       s   e   l   f   .   _   g   e   t   _   f   e   a   t   u   r   e   _   v   e   c   t   o   r   _   a   t   t   e   n   t   i   o   n   _   m   a   s   k   (   
                                                                   e   x   t   r   a   c   t   _   f   e   a   t   u   r   e   s   .   s   h   a   p   e   [   1   ]   ,       a   t   t   e   n   t   i   o   n   _   m   a   s   k   ,   